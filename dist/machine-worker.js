var fr=Object.defineProperty;var mr=(e,t)=>{for(var r in t)fr(e,r,{get:t[r],enumerable:!0})};var l=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var Ht="A1",Zt="B0",Wt="B1",Ae="ADD",lr=e=>{switch(e){case 0:return Ht;case 1:return Zt;case 2:return Wt}},hr=e=>{switch(e){case Ht:return 0;case Zt:return 1;case Wt:return 2}},b=class e extends l{constructor(t){super(),this.op=t}pretty(){return`${Ae} ${lr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Ae&&(s===Ht||s===Zt||s===Wt))return new e(hr(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var Et="INC",Vt="TDEC",bt="READ",Nt="SET",Ft="B2DX",Yt="B2DY",jt="B2D",dr="DEC",De="SQX",Be="SQY",Re="SQ",Ie=e=>{switch(e){case Et:return 0;case Vt:return 1;case bt:return 2;case Nt:return 3}},gr=e=>{switch(e){case 0:return Et;case 1:return Vt;case 2:return bt;case 3:return Nt}},Ce=e=>{switch(e){case Ft:return 4;case Yt:return 5;case jt:return 6}},xr=e=>{switch(e){case 4:return Ft;case 5:return Yt;case 6:return jt}},_=class e extends l{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${gr(this.op)} ${xr(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)){if(n===Et||n===Vt){if(s===Ft||s===Yt)return new e(Ie(n),Ce(s))}else if((n===bt||n===Nt)&&s===jt)return new e(Ie(n),Ce(s));switch(n){case Et:switch(s){case De:return new e(0,4);case Be:return new e(0,5);default:return}case dr:switch(s){case De:return new e(1,4);case Be:return new e(1,5);default:return}case bt:switch(s){case Re:return new e(2,6);default:return}case Nt:switch(s){case Re:return new e(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof e){let r=this.axis,n=t.axis;return r===4&&n===5?!1:!(r===5&&n===4)}return!1}};var Xt="INC",Jt="TDEC",Kt="READ",Qt="SET",_e="B",yr=e=>{switch(e){case 0:return Xt;case 1:return Jt;case 2:return Kt;case 3:return Qt}},Sr=e=>{switch(e){case Xt:return 0;case Jt:return 1;case Kt:return 2;case Qt:return 3}},h=class e extends l{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${yr(this.op)} ${_e}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===Xt||n===Jt||n===Kt||n===Qt)&&s.startsWith(_e)){let o=s.slice(1);if(/^[0-9]+$/u.test(o))return new e(Sr(n),parseInt(o,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var $e="HALT_OUT",Oe="HALT",y=class e extends l{constructor(t=!0){super(),this.output=t}pretty(){return this.output?$e:Oe}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===$e)return new e(!0);if(n===Oe)return new e(!1)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var qt="0",te="1",ve="MUL",Er=e=>{switch(e){case qt:return 0;case te:return 1}},br=e=>{switch(e){case 0:return qt;case 1:return te}},$=class e extends l{constructor(t){super(),this.op=t}pretty(){return`${ve} ${br(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===ve&&(s===qt||s===te))return new e(Er(s))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var Me="NOP",W=class e extends l{constructor(){super()}pretty(){return Me}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Me)return new e}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var Ue="OUTPUT",O=class e extends l{constructor(t){super(),this.digit=t}pretty(){return`${Ue} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Ue&&s!==void 0)return new e(s)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var ee="A1",re="B0",ne="B1",Le="SUB",Nr=e=>{switch(e){case 0:return ee;case 1:return re;case 2:return ne}},wr=e=>{switch(e){case ee:return 0;case re:return 1;case ne:return 2}},v=class e extends l{constructor(t){super(),this.op=t}pretty(){return`${Le} ${Nr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Le&&(s===ee||s===re||s===ne))return new e(wr(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var se="INC",oe="TDEC",Pe="U",Tr="R",Ar=e=>{switch(e){case 0:return se;case 1:return oe}},Dr=e=>{switch(e){case se:return 0;case oe:return 1}},d=class e extends l{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Ar(this.op)} ${Pe}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===se||n===oe)&&(s.startsWith(Pe)||s.startsWith(Tr))){let o=s.slice(1);if(/^[0-9]+$/u.test(o))return new e(Dr(n),parseInt(o,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var ie="INC",ae="DEC",ce="READ",ue="SET",pe="RESET",Br=e=>{switch(e){case 0:return ie;case 1:return ae;case 2:return ce;case 3:return ue;case 4:return pe}},Rr=e=>{switch(e){case ie:return 0;case ae:return 1;case ce:return 2;case ue:return 3;case pe:return 4}},M=class e extends l{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${Br(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===ie||n===ae||n===ce||n===ue||n===pe)&&s.startsWith("T")){let o=s.slice(1);if(/^[0-9]+$/u.test(o))return new e(Rr(n),parseInt(o,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var u=()=>{throw Error("internal error")};var At=class{constructor(){this.value=0}action(t){switch(t.op){case 1:{let r=this.value,n=r%2;return this.value=[0,0,0,0,0,0,9,9,0,0,9,9,9,9,9,9][r]??u(),n}case 2:{let r=this.value,n=1-r%2;return this.value=[0,0,0,0,9,9,0,0,9,9,0,0,9,9,9,9][r]??u(),n}case 0:{this.value=[5,4,7,6,1,0,3,2,13,12,15,14,9,8,11,10][this.value]??u();return}default:u()}}getValue(){return this.value}a1(){this.action(new b(0))}b0(){let t=this.action(new b(1));return t===void 0&&u(),t}b1(){let t=this.action(new b(2));return t===void 0&&u(),t}toString(){return this.value.toString(2).padStart(4,"0")}toStringDetail(){let t=this.toString();return`${t.slice(0,3)} bit${t.slice(3)}`}};var fe=(e,t)=>Array(e).fill(0).map((r,n)=>t(n)),Dt=class{constructor(){this.x=0,this.y=0,this.maxX=0,this.maxY=0,this.array=fe(1,()=>fe(1,()=>0))}getArray(){return this.array}getMaxX(){return this.maxX}getMaxY(){return this.maxY}action(t){switch(t.op){case 0:{switch(t.axis){case 4:return this.incB2DX();case 5:return this.incB2DY();case 6:u()}break}case 1:{switch(t.axis){case 4:return this.tdecB2DX();case 5:return this.tdecB2DY();case 6:u()}break}case 2:{switch(t.axis){case 6:return this.read();default:u()}break}case 3:{switch(t.axis){case 6:return this.set();default:u()}break}default:u()}}incB2DX(){if(this.x++,this.maxX<this.x){for(let t of this.array)t.push(0);this.maxX=this.x}}incB2DY(){this.y++,this.maxY<this.y&&(this.array.push(fe(this.maxX+1,()=>0)),this.maxY=this.y)}tdecB2DX(){return this.x===0?0:(this.x--,1)}tdecB2DY(){return this.y===0?0:(this.y--,1)}read(){let t=this.array[this.y];t===void 0&&u();let r=t[this.x];return r===void 0&&u(),t[this.x]=0,r}set(){let t=this.array[this.y]??u();if(t[this.x]===1)throw Error(`SET B2D: Tried to set when it was already 1. x = ${this.x}, y = ${this.y}`);t[this.x]=1}};var Bt=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.value===0?0:(this.value--,1);case 0:this.value++}}actionN(t,r){switch(t.op){case 1:{this.value-=r;break}case 0:{this.value+=r;break}}}getValue(){return this.value}setValue(t){this.value=t}inc(){this.action(new d(0,0))}tdec(){let t=this.action(new d(1,0));return t===void 0&&u(),t}setByRegistersInit(t,r){(typeof r!="number"||r<0||!Number.isInteger(r))&&U(t,r),this.setValue(r)}},U=(e,t)=>{let r=`"${e}": ${JSON.stringify(t)}`;throw Error(`Invalid #REGISTERS ${r}`)};var ke=e=>[...e].map(t=>{if(t==="0")return 0;if(t==="1")return 1;throw Error(`Invalid #REGISTERS: "${e}"`)}),Rt=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 1:return this.pointer===0?0:(this.pointer--,1);case 0:{let r=this.pointer+1;this.pointer=r;let n=this.bits;r===n.length&&n.push(0);break}case 2:{let r=this.pointer,n=this.bits;if(r<n.length){let s=n[r]??u();return n[r]=0,s}else return 0}case 3:{let r=this.bits,n=this.pointer;if(n>=r.length&&this.extend(),r[n]===1)throw Error(`The bit of the binary register B${t.regNumber} is already 1`);r[n]=1;break}default:{let r=t.op}}}actionN(t,r){switch(t.op){case 0:{this.pointer+=r,this.extend();break}case 1:{this.pointer-=r;break}default:throw Error("todo")}}getBits(){return this.bits}setBits(t){this.bits=t}inc(){let t=this.action(new h(0,0));return t!==void 0&&u(),t}tdec(){let t=this.action(new h(1,0));return t===void 0&&u(),t}read(){let t=this.action(new h(2,0));return t===void 0&&u(),t}set(){let t=this.action(new h(3,0));return t!==void 0&&u(),t}extend(){let t=this.pointer,r=this.bits,n=r.length;if(t>=n)if(t===n)r.push(0);else{let s=Array(t-n+1).fill(0).map(()=>0);this.bits=this.bits.concat(s)}}toObject(){this.extend();let t=this.bits,r=this.pointer;return{prefix:t.slice(0,r),head:t[r]??u(),suffix:t.slice(r+1)}}setByRegistersInit(t,r){if(typeof r=="number")this.setBits(ke(r.toString(2)).reverse()),this.extend();else if(!Array.isArray(r)||r.length!==2)U(t,r);else{let[n,s]=r;if(typeof n!="number"||typeof s!="string"||n<0||!Number.isInteger(n))U(t,r);else{let o=ke(s);this.pointer=n,this.setBits(o),this.extend()}}}};var It=class{constructor(){this.value=0}action(t){switch(t.op){case 0:return this.mul0();case 1:return this.mul1();default:throw Error("MUL: action")}}getValue(){return this.value}mul0(){let t=this.value,r=t%2;return this.value=t>>1,r}mul1(){let t=this.value,r=t%2;return t<=21?this.value=(t>>1)+5:this.value=t-22>>1,r}toString(){return this.value.toString(2).padStart(5,"0")}};var Ct=class{constructor(){}action(){return 0}};var _t=class{#t="";constructor(){}action(t){this.output(t.digit)}getString(){return this.#t}output(t){this.#t+=t}};var $t=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.b0();case 0:return this.a1();case 2:return this.b1();default:u()}}getValue(){return this.value}a1(){let r=[3,2,-1,-1,7,6,-1,-1,11,10,-1,-1,15,14,-1,-1,19,18,-1,-1,23,22,-1,-1,27,26,-1,-1,31,30,-1,-1][this.value]??u();if(r===-1)throw Error("SUB error: A1");this.value=r}b0(){let t=this.value%2,r=[0,0,0,0,17,17,0,0,0,0,0,0,0,0,17,17,17,17,0,0,17,17,17,17,0,0,17,17,17,17,17,17];return this.value=r[this.value]??u(),t}b1(){let t=1-this.value%2,r=[17,17,0,0,0,0,0,0,0,0,17,17,0,0,0,0,17,17,17,17,17,17,0,0,17,17,17,17,0,0,17,17];return this.value=r[this.value]??u(),t}toString(){return this.value.toString(2).padStart(5,"0")}toStringDetail(){let t=this.toString();return t.slice(0,3)+" stopper"+t.slice(3,4)+" bit"+t.slice(4)}};var Ot=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 0:return this.inc();case 2:return this.read();case 1:return this.dec();case 3:return this.set();case 4:return this.reset();default:u()}}getPointer(){return this.pointer}getBits(){return this.bits}inc(){let t=this.bits;return this.pointer===t.length-1?(t.push(0),this.pointer++,0):(this.pointer++,1)}dec(){return this.pointer===0?0:(this.pointer--,1)}read(){let t=this.pointer,r=this.bits,n=r[t];if(n===0)return r[t]=-1,0;if(n===1)return r[t]=-1,1;if(n===-1)throw Error("Error: reading empty space of T register");u()}set(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=1;else throw Error("Error: SET to nonempty bit")}reset(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=0;else throw Error("Error: RESET to nonempty bit")}};var gt=(e,t)=>{throw Error(`Register ${e}${t} is not found.`)},Ge=Number.parseInt,ze=Number.isNaN,vt=class{constructor({unary:t,binary:r,legacyT:n}){this.uRegMap=new Map(t.map(s=>[s,new Bt])),this.bRegMap=new Map(r.map(s=>[s,new Rt])),this.legacyTRegMap=new Map(n.map(s=>[s,new Ot])),this.add=new At,this.sub=new $t,this.mul=new It,this.b2d=new Dt,this.output=new _t,this.nop=new Ct}setByRegistersInit(t){for(let[r,n]of Object.entries(t))this.#t(r,n)}setCache(t){t instanceof h?t.registerCache=this.getBReg(t.regNumber):t instanceof d&&(t.registerCache=this.getUReg(t.regNumber))}#t(t,r){if(t.startsWith("U")){let n=Ge(t.slice(1),10);ze(n)&&U(t,r);let s=this.getUReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: U${n} isn't used in the program`);s.setByRegistersInit(t,r)}else if(t.startsWith("B")){let n=Ge(t.slice(1),10);ze(n)&&U(t,r);let s=this.getBReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: B${n} isn't used in the program`);s.setByRegistersInit(t,r)}else U(t,r)}execAction(t){if(t instanceof h)return(t.registerCache??this.bRegMap.get(t.regNumber)??gt("B",t.regNumber)).action(t);if(t instanceof d)return(t.registerCache??this.uRegMap.get(t.regNumber)??gt("U",t.regNumber)).action(t);if(t instanceof b)return this.add.action(t);if(t instanceof W)return this.nop.action();if(t instanceof v)return this.sub.action(t);if(t instanceof $)return this.mul.action(t);if(t instanceof _)return this.b2d.action(t);if(t instanceof O)return this.output.action(t);if(t instanceof y)return-1;if(t instanceof M)return(this.legacyTRegMap.get(t.regNumber)??gt("T",t.regNumber)).action(t);throw Error(`execAction: unknown action ${t.pretty()}`)}execActionN(t,r){if(t instanceof d)return(t.registerCache??this.uRegMap.get(t.regNumber)??gt("U",t.regNumber)).actionN(t,r);if(t instanceof h)return(t.registerCache??this.bRegMap.get(t.regNumber)??gt("B",t.regNumber)).actionN(t,r);if(t instanceof y)return-1;throw Error(`execActionN: ${t.pretty()}`)}getUReg(t){return this.uRegMap.get(t)}getBReg(t){return this.bRegMap.get(t)}addSubMulToUIString(){return`
        ADD = ${this.add.toStringDetail()},
        SUB = ${this.sub.toStringDetail()},
        MUL = ${this.mul.toString()}
        `}};var Ir=[h.parse,d.parse,_.parse,W.parse,b.parse,$.parse,v.parse,O.parse,y.parse,M.parse],me=e=>{for(let t of Ir){let r=t(e);if(r!==void 0)return r}};var S=e=>e!==void 0?` at line ${e}`:"";function le(e,t,r,n){if(e=e.trim(),!e.startsWith("{"))return`Invalid line "${r}"${S(t)}. ${n} replacements does not start with "{"`;if(!e.endsWith("}"))return`Invalid line "${r}"${S(t)}. ${n} replacements does not end with "}"`;try{return e.slice(1,-1).slice().split(";").map(s=>{let o=s.trim().split("=").map(i=>i.trim());if(o.length!=2)throw new Error(`Invalid line "${r}"${S(t)}. #DEFINE invalid replacements`);return{needle:o[0]??u(),replacement:o[1]??u()}})}catch(s){return s instanceof Error?s.message:u()}}var xt="INITIAL",E=class{pretty(){return""}},F=class e extends E{constructor(t){super(),this.content=t}static get key(){return"#COMPONENTS"}pretty(){return e.key+" "+this.content}},Y=class e extends E{constructor(t){super(),this.content=t}static get key(){return"#REGISTERS"}pretty(){return e.key+" "+this.content}};function He(e){return"{ "+e.map(t=>t.needle+" = "+t.replacement).join("; ")+" }"}var j=class e extends E{constructor(t,r){super(),this.name=t,this.defaultReplacements=r}static get key(){return"#DEFINE"}pretty(){return e.key+" "+this.name+(this.defaultReplacements.length===0?"":" "+He(this.defaultReplacements))}},P=class e extends E{constructor(){super()}static get key(){return"#ENDDEF"}pretty(){return e.key}},L=class e extends E{constructor(t,r){super(),this.templateName=t,this.replacements=r}static get key(){return"#INSERT"}pretty(){return e.key+" "+this.templateName+(this.replacements.length===0?"":" "+He(this.replacements))}},X=class extends E{constructor(t){super(),this.filename=t}static get key(){return"#INCLUDE"}pretty(){return L.key+" "+this.filename}},he=class extends E{constructor(t){super(),this.str=t}getString(){return this.str}pretty(){return this.getString()}},de=class extends E{constructor(){super()}pretty(){return""}},Cr=e=>{switch(e){case"Z":return e;case"NZ":return e;case"ZZ":return e;case"*":return e;default:return}},st=class extends E{constructor({state:t,input:r,nextState:n,actions:s,line:o}){super(),this.state=t,this.input=r,this.nextState=n,this.actions=s,this.line=o,this._string=`${this.state}; ${this.input};${" ".repeat(2-this.input.length)} ${this.nextState}; ${this.actions.map(i=>i.pretty()).join(", ")}`}pretty(){return this._string}},ge=(e,t)=>{let r=e.trim();if(r==="")return new de;if(r.startsWith("#")){if(r.startsWith(F.key))return new F(r.slice(F.key.length).trim());if(r.startsWith(Y.key))return new Y(r.slice(Y.key.length).trim());if(r.startsWith(j.key)){let m=r.slice(j.key.length).trim();if(m.length===0)return`Invalid line "${e}"${S(t)}. #DEFINE needs a name.`;let g,at=[],G=m.indexOf("{");if(G!==-1){g=m.slice(0,G).trim();let z=le(m.slice(G),t,e,"#DEFINE");if(typeof z=="string")return z;at=z}else g=m;return new j(g,at??[])}else{if(r.startsWith(P.key))return new P;if(r.startsWith(L.key)){let m=r.slice(L.key.length).trim();if(m.length===0)return`Invalid line "${e}"${S(t)}. #INSERT needs a name.`;let g,at=[],G=m.indexOf("{");if(G!==-1){g=m.slice(0,G).trim();let z=le(m.slice(G),t,e,"#INSERT");if(typeof z=="string")return z;at=z}else g=m;return new L(g,at)}else if(r.startsWith(X.key)){let m=r.slice(X.key.length).trim();return m===""?`Invalid line "${e}"${S(t)}. #INCLUDE needs filename.`:new X(m)}}return new he(e)}let s=(r.split("#")[0]??"").split(/\s*;\s*/u);if(s.length<4)return`Invalid line "${e}"${S(t)}`;if(s.length>4)return s[4]===""?`Extraneous semicolon "${e}"${S(t)}`:`Invalid line "${e}"${S(t)}`;let o=s[0]??u(),i=s[1]??u(),a=s[2]??u(),p=(s[3]??u()).trim().split(/\s*,\s*/u).filter(m=>m!==""),f=[];for(let m of p){let g=me(m);if(g===void 0)return`Unknown action "${m}" in "${e}"${S(t)}`;f.push(g)}let x=Cr(i);return x===void 0?`Unknown input "${i}" in "${e}"${S(t)}. Expect "Z", "NZ", "ZZ" or "*"`:new st({state:o,input:x,nextState:a,actions:f,line:t})},C=e=>S(e.line),N=e=>`"${e.pretty()}"${C(e)}`;var Ze=e=>{let t=e.actions;if(t.some(n=>n instanceof y))return;let r=t.filter(n=>n.doesReturnValue());if(r.length!==1)return r.length===0?`Does not return a value in ${N(e)}`:`Does not contain exactly one action that returns a value in "${e.pretty()}": Actions that produce value are ${r.map(n=>`"${n.pretty()}"`).join(", ")}${C(e)}`};var We=e=>{if(e.nextState===xt)return`Return to initial state in ${N(e)}`};var Ve=e=>{let t=e.actions;if(t.length<=1)return;let r=t.map(s=>s.pretty());r.sort();let n=r.length-1;for(let s=0;s<n;s++){let o=r[s],i=r[s+1];if(o===i)return`Duplicated actions "${o}" in ${N(e)}`}};var Fe=e=>{let t=e.actions;if(t.find(n=>n instanceof y)!==void 0)return;let r=t.length;if(!(r<=1))for(let n=0;n<r;n++){let s=t[n]??u();for(let o=n+1;o<r;o++){let i=t[o]??u();if(s.isSameComponent(i))return`Actions "${s.pretty()}" and "${i.pretty()}" use same component in ${N(e)}`}}};var _r=(e,t)=>e.line!==void 0&&t?.line!==void 0?` at line ${e.line} and ${t.line}`:"",Ye=e=>{if(e.length===0)return;let t=(s,o)=>`Need Z line followed by NZ line in "${s.pretty()}"${_r(s,o)}`,r=e.length-1;for(let s=0;s<r;s++){let o=e[s]??u(),i=e[s+1]??u(),a=o.input,c=i.input;if(a==="Z"&&c!=="NZ"||c==="NZ"&&a!=="Z"||a==="Z"&&c==="NZ"&&o.state!==i.state)return[t(o,i)]}let n=e[r];if(n?.input==="Z")return[t(n)]};var k=class e{constructor(t,r=new Map){this.templates=r,this.array=t}getArray(){return this.array}getTemplates(){return this.templates}pretty(){return this.array.map(t=>t.pretty()).join(`
`)}static parse(t){let r=t.split(/\r\n|\n|\r/u),n=[],s=[],o=new Map,i=null;for(let[a,c]of r.entries()){if(i!=null){if(c.trimStart().startsWith(P.key)&&ge(c,a+1)instanceof P){i=null;continue}let f=o.get(i);f==null&&u(),f.lines.push(c);continue}let p=ge(c,a+1);if(p instanceof j){if(i!=null)return`#DEFINE needs #ENDDEF ${p.pretty()}`;if(i=p.name,o.has(i))return`#DEFINE duplicate template name ${p.pretty()}`;o.set(i,{defaultReplacements:p.defaultReplacements,lines:[]})}else{if(p instanceof P)return`#ENDDEF needs #DEFINE ${p.pretty()}`;p instanceof E?s.push(p):typeof p=="string"?n.push(p):u()}}return i!=null&&n.push(`#DEFINE needs #ENDDEF. "${i}"`),n.length>0?n.join(`
`):new e(s,o)}};var je=e=>{let t=[];{let r=[Ve,Ze,Fe,We];for(let n of e)for(let s of r){let o=s(n);typeof o=="string"&&t.push(o)}}{let r=[Ye];for(let n of r){let s=n(e);s!==void 0&&(t=t.concat(s))}}if(t.length>0)return t.join(`
`)};function $r(e,t,r){let n=e;for(let s of r)n=n.replaceAll(s.needle,s.replacement);for(let s of t.defaultReplacements)n=n.replaceAll(s.needle,s.replacement);return n}function Xe(e,t){let r=[],n=new Map(e.getTemplates().entries()),s=e.getArray().slice().reverse();function o(i){let a=i.getArray();for(let c=a.length-1;c>=0;c--)s.push(a[c]??u());for(let[c,p]of i.getTemplates()){if(n.get(c)!=null)throw new Error(`#DEFINE duplicate template name "${c}"`);n.set(c,p)}}for(;s.length>=1;){let i=s.pop();if(i instanceof st)r.push(i);else if(i instanceof X){let a=t.find(c=>c.name===i.filename);if(a==null)throw new Error(`#INCLUDE file not found: "${i.filename}". Add a library file.`);o(a.programLines)}else if(i instanceof L){let a=n.get(i.templateName);if(a==null)throw new Error(`Undefined template: "${i.templateName}" at line "${i.pretty()}"`);let c=a.lines.map(f=>$r(f,a,i.replacements)).join(`
`),p=k.parse(c);if(typeof p=="string")throw new Error(p);o(p)}}return r}var Je="CLOCK-2^";function Qe(e){let t=[],r=e.split(",").map(n=>n.trim());for(let n of r)if(n!=="..."&&!(n==="NOP"||n==="HALT_OUT")){if(n==="OUTPUT"||n==="B2D"||n==="ADD"||n==="SUB"||n==="MUL")t.push(n);else if(n.startsWith(Je)){let s=Number(n.slice(Je.length))}else if(n.startsWith("B")){let s=Ke(n.slice(1));for(let o of s.map(i=>`B${i}`))t.push(o)}else if(n.startsWith("U")){let s=Ke(n.slice(1));for(let o of s.map(i=>`U${i}`))t.push(o)}}return t}function Ke(e){let t=e.split("-");if(t.length===1){if(t[0]?.length===0)throw new Error("Invalid #COMPONENTS");let r=Number(t[0]);if(Number.isNaN(r))throw new Error("Invalid #COMPONENTS");return[r]}else if(t.length===2){if(t.some(o=>o.length===0))throw new Error("Invalid #COMPONENTS");let[r,n]=t.map(o=>Number(o));if(r==null||n==null||Number.isNaN(r)||Number.isNaN(n))throw new Error("Invalid #COMPONENTS");let s=[];for(let o=r;o<n+1;o++)s.push(o);return s}throw new Error("Invalid #COMPONENTS")}var yt=class e{constructor(t,r,n){this.commands=t,this.componentsHeader=r,this.registersHeader=n}static parse(t,{noValidate:r,libraryFiles:n}={}){let s=k.parse(t);if(typeof s=="string")return s;let o=[];for(let a of n??[]){let c=k.parse(a.content);if(typeof c=="string")return c;o.push({name:a.name,programLines:c})}let i=Xe(s,o);if(!r){if(i.length===0)return"Program is empty";let a=je(i);if(typeof a=="string")return a}return new e(i,s.getArray().flatMap(a=>a instanceof F?[a]:[]),s.getArray().flatMap(a=>a instanceof Y?[a]:[]))}},Or=e=>[...new Set(e)].sort((t,r)=>t-r),xe=e=>{let t=e.commands.flatMap(c=>c.actions),r=c=>Or(t.flatMap(p=>p instanceof c?[p.regNumber]:[])),n=!1,s=!1,o=!1,i=!1,a=!1;for(let c of t)c instanceof b?n=!0:c instanceof v?s=!0:c instanceof $?o=!0:c instanceof _?i=!0:c instanceof O&&(a=!0);return{unary:r(d),binary:r(h),legacyT:r(M),hasAdd:n,hasSub:s,hasMul:o,hasB2D:i,hasOutput:a}},qe=(e,t)=>{let r=[],n=new Set(e.flatMap(i=>Qe(i.content)));t.hasAdd&&(n.has("ADD")||r.push("Program uses ADD component but the #COMPONENTS header does not include it.")),t.hasSub&&(n.has("SUB")||r.push("Program uses SUB component but the #COMPONENTS header does not include it.")),t.hasMul&&(n.has("MUL")||r.push("Program uses MUL component but the #COMPONENTS header does not include it.")),t.hasB2D&&(n.has("B2D")||r.push("Program uses B2D component but the #COMPONENTS header does not include it.")),t.hasOutput&&(n.has("OUTPUT")||r.push("Program uses OUTPUT component but the #COMPONENTS header does not include it."));let s=[];for(let i of t.unary)n.has("U"+i)||s.push(i);s.length>0&&r.push(`Program uses ${s.map(i=>"U"+i).join(", ")} component${s.length===1?"":"s"} but the #COMPONENTS header does not include it.`);let o=[];for(let i of t.binary)n.has("B"+i)||o.push(i);if(o.length>0&&r.push(`Program uses ${o.map(i=>"B"+i).join(", ")} component${o.length===1?"":"s"} but the #COMPONENTS header does not include it.`),r.length!==0)throw new Error(r.join(`
`))};var vr=e=>e instanceof h&&e.op===0,Mr=e=>e instanceof d&&e.op===1,Ur=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof y))&&e.actions.every(t=>t instanceof d||vr(t))){let t=e.actions.find(Mr);if(t&&t instanceof d)return{tdecU:t}}},Lr=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof y))&&e.actions.length===1&&e.actions.every(t=>t instanceof h)){let t=e.actions.find(r=>r instanceof h&&r.op===1);if(t&&t instanceof h)return{tdecB:t}}},ot=class{constructor(t,r){this.command=t,this.nextState=r,this.tdecuOptimize=Ur(t),this.tdecbOptimize=Lr(t)}},Se=class{constructor(t,r){this.z=t,this.nz=r}},ye=(e,t)=>{throw Error(`Duplicated command: "${e.pretty()}" and "${t.pretty()}"${C(t)}`)},tr=e=>{let t=new Map,r=[];for(let n of e)t.has(n.state)||(t.set(n.state,t.size),r.push(new Se(void 0,void 0)));for(let n of e){let s=r[t.get(n.state)??u()]??u(),o=t.get(n.nextState);if(o===void 0)throw Error(`Unknown state: "${n.nextState}" at "${n.pretty()}"${C(n)}`);switch(n.input){case"Z":{s.z===void 0?s.z=new ot(n,o):ye(s.z.command,n);break}case"NZ":{s.nz===void 0?s.nz=new ot(n,o):ye(s.nz.command,n);break}case"ZZ":{if(s.nz!==void 0)throw Error(`Invalid input: ZZ with NZ or *: "${n.pretty()}" and "${s.nz.command.pretty()}"${C(n)}`);s.z===void 0?s.z=new ot(n,o):ye(s.z.command,n);break}case"*":{if(s.nz!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.nz.command.pretty()}"${C(n)}`);if(s.z!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.z.command.pretty()}"${C(n)}`);{let i=new ot(n,o);s.z=i,s.nz=i}break}default:u()}}return{states:[...t.keys()],stateMap:t,lookup:r}};var w=(e="error")=>{throw Error(e)},St=class e{constructor(t){this.stepCount=0;let r=xe(t);this.actionExecutor=new vt(r),this.prevOutput=0;let{states:n,stateMap:s,lookup:o}=tr(t.commands);this.lookup=o;for(let a of o){let c=(a.z?.command.actions??[]).concat(a.nz?.command.actions??[]);for(let p of c)this.actionExecutor.setCache(p)}this.currentStateIndex=s.get(xt)??w(`${xt} state is not present`),this.stateStatsArray=[],this.states=n,this.stateMap=s,this.program=t,this.analyzeResult=r;for(let a=0;a<o.length*2;a++)this.stateStatsArray.push(0);let i=t.registersHeader;for(let a of i)this.#t(a);t.componentsHeader.length>0&&qe(t.componentsHeader,r)}static fromString(t,r){let n=yt.parse(t,{libraryFiles:r??[]});if(typeof n=="string")throw Error(n);return new e(n)}getStateStats(){let t=this.stateStatsArray,r=t.length,n=[];for(let s=0;s<r;s+=2)n.push({z:t[s]??w(),nz:t[s+1]??w()});return n}#t(t){let r=t.content.replace(/'/ug,'"'),n={};try{n=JSON.parse(r)}catch{w(`Invalid #REGISTERS: is not a valid JSON: "${r}"`)}(n===null||typeof n!="object")&&w(`Invalid #REGISTERS: "${r}" is not an object`),this.actionExecutor.setByRegistersInit(n)}getCurrentState(){let t=this.states[this.currentStateIndex];return t===void 0&&w("State name is not found"),t}getStateMap(){return this.stateMap}getPreviousOutput(){return this.prevOutput===0?"Z":"NZ"}getNextCommand(){let t=this.currentStateIndex,r=this.lookup[t];if(r===void 0&&w(`Internal Error: Next command is not found: Current state index: ${t}`),this.prevOutput===0){let s=r.z;if(s!==void 0)return s}else{let s=r.nz;if(s!==void 0)return s}w("Next command is not found: Current state = "+this.getCurrentState()+", output = "+this.getPreviousOutput())}_internalExecActionN(t,r){try{let s=this.actionExecutor;for(let o of t.actions)s.execActionN(o,r)}catch(s){if(s instanceof Error)this.#e(s);else throw s}let n=this.currentStateIndex*2+this.prevOutput;this.stateStatsArray[n]=(this.stateStatsArray[n]??0)+r,this.stepCount+=r}exec(t,r,n,s){let o=n!==-1,i=performance.now();for(let a=0;a<t;a++){let c=this.getNextCommand();if(c.tdecuOptimize){let f=c.tdecuOptimize.tdecU.registerCache?.getValue();if(f!==void 0&&f!==0){f=Math.min(f,t-a),this._internalExecActionN(c.command,f),a+=f-1;continue}}else if(c.tdecbOptimize){let f=c.tdecbOptimize.tdecB.registerCache?.pointer;if(f!==void 0&&f!==0){f=Math.min(f,t-a),this._internalExecActionN(c.command,f),a+=f-1;continue}}try{if(this.execCommandFor(c)===-1)return"Halted"}catch(p){if(p instanceof Error)this.#e(p);else throw p}if(o&&this.currentStateIndex===n&&(s===-1||s===this.prevOutput))return"Stop";if(r&&(a+1)%5e5===0&&performance.now()-i>=50)return}}#e(t){let r=this.getNextCommand().command;return w(t.message+" in "+N(r))}execCommandFor(t){this.stepCount+=1;{let i=this.currentStateIndex,a=this.prevOutput,c=i*2+a;this.stateStatsArray[c]=(this.stateStatsArray[c]??0)+1}let r=-1,n=this.actionExecutor,s=t.command;for(let i of s.actions){let a=n.execAction(i);if(a===-1)return-1;a!==void 0&&(r===-1?r=a:w(`Return value twice: line = ${N(s)}`))}r===-1&&w(`No return value: line = ${N(s)}`);let o=t.nextState;this.currentStateIndex=o,this.prevOutput=r}execCommand(){return this.execCommandFor(this.getNextCommand())}};var zt={};mr(zt,{createEndpoint:()=>rr,expose:()=>we,finalizer:()=>Ut,proxy:()=>pr,proxyMarker:()=>be,releaseProxy:()=>nr,transfer:()=>ur,transferHandlers:()=>Ne,windowEndpoint:()=>Vr,wrap:()=>ir});var be=Symbol("Comlink.proxy"),rr=Symbol("Comlink.endpoint"),nr=Symbol("Comlink.releaseProxy"),Ut=Symbol("Comlink.finalizer"),Lt=Symbol("Comlink.thrown"),sr=e=>typeof e=="object"&&e!==null||typeof e=="function",Pr={canHandle:e=>sr(e)&&e[be],serialize(e){let{port1:t,port2:r}=new MessageChannel;return we(e,t),[r,[r]]},deserialize(e){return e.start(),ir(e)}},kr={canHandle:e=>sr(e)&&Lt in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},Ne=new Map([["proxy",Pr],["throw",kr]]);function Gr(e,t){for(let r of e)if(t===r||r==="*"||r instanceof RegExp&&r.test(t))return!0;return!1}function we(e,t=globalThis,r=["*"]){t.addEventListener("message",function n(s){if(!s||!s.data)return;if(!Gr(r,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}let{id:o,type:i,path:a}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(J),p;try{let f=a.slice(0,-1).reduce((m,g)=>m[g],e),x=a.reduce((m,g)=>m[g],e);switch(i){case"GET":p=x;break;case"SET":f[a.slice(-1)[0]]=J(s.data.value),p=!0;break;case"APPLY":p=x.apply(f,c);break;case"CONSTRUCT":{let m=new x(...c);p=pr(m)}break;case"ENDPOINT":{let{port1:m,port2:g}=new MessageChannel;we(e,g),p=ur(m,[m])}break;case"RELEASE":p=void 0;break;default:return}}catch(f){p={value:f,[Lt]:0}}Promise.resolve(p).catch(f=>({value:f,[Lt]:0})).then(f=>{let[x,m]=Gt(f);t.postMessage(Object.assign(Object.assign({},x),{id:o}),m),i==="RELEASE"&&(t.removeEventListener("message",n),or(t),Ut in e&&typeof e[Ut]=="function"&&e[Ut]())}).catch(f=>{let[x,m]=Gt({value:new TypeError("Unserializable return value"),[Lt]:0});t.postMessage(Object.assign(Object.assign({},x),{id:o}),m)})}),t.start&&t.start()}function zr(e){return e.constructor.name==="MessagePort"}function or(e){zr(e)&&e.close()}function ir(e,t){let r=new Map;return e.addEventListener("message",function(s){let{data:o}=s;if(!o||!o.id)return;let i=r.get(o.id);if(i)try{i(o)}finally{r.delete(o.id)}}),Ee(e,r,[],t)}function Mt(e){if(e)throw new Error("Proxy has been released and is not useable")}function ar(e){return it(e,new Map,{type:"RELEASE"}).then(()=>{or(e)})}var Pt=new WeakMap,kt="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let t=(Pt.get(e)||0)-1;Pt.set(e,t),t===0&&ar(e)});function Hr(e,t){let r=(Pt.get(t)||0)+1;Pt.set(t,r),kt&&kt.register(e,t,e)}function Zr(e){kt&&kt.unregister(e)}function Ee(e,t,r=[],n=function(){}){let s=!1,o=new Proxy(n,{get(i,a){if(Mt(s),a===nr)return()=>{Zr(o),ar(e),t.clear(),s=!0};if(a==="then"){if(r.length===0)return{then:()=>o};let c=it(e,t,{type:"GET",path:r.map(p=>p.toString())}).then(J);return c.then.bind(c)}return Ee(e,t,[...r,a])},set(i,a,c){Mt(s);let[p,f]=Gt(c);return it(e,t,{type:"SET",path:[...r,a].map(x=>x.toString()),value:p},f).then(J)},apply(i,a,c){Mt(s);let p=r[r.length-1];if(p===rr)return it(e,t,{type:"ENDPOINT"}).then(J);if(p==="bind")return Ee(e,t,r.slice(0,-1));let[f,x]=er(c);return it(e,t,{type:"APPLY",path:r.map(m=>m.toString()),argumentList:f},x).then(J)},construct(i,a){Mt(s);let[c,p]=er(a);return it(e,t,{type:"CONSTRUCT",path:r.map(f=>f.toString()),argumentList:c},p).then(J)}});return Hr(o,e),o}function Wr(e){return Array.prototype.concat.apply([],e)}function er(e){let t=e.map(Gt);return[t.map(r=>r[0]),Wr(t.map(r=>r[1]))]}var cr=new WeakMap;function ur(e,t){return cr.set(e,t),e}function pr(e){return Object.assign(e,{[be]:!0})}function Vr(e,t=globalThis,r="*"){return{postMessage:(n,s)=>e.postMessage(n,r,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function Gt(e){for(let[t,r]of Ne)if(r.canHandle(e)){let[n,s]=r.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},cr.get(e)||[]]}function J(e){switch(e.type){case"HANDLER":return Ne.get(e.name).deserialize(e.value);case"RAW":return e.value}}function it(e,t,r,n){return new Promise(s=>{let o=Fr();t.set(o,s),e.start&&e.start(),e.postMessage(Object.assign({id:o},r),n)})}function Fr(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var Te=class{#t;async init(t,r){this.#t=St.fromString(t,r)}async terminate(){this.terminate()}async getBRegMap(){return new Map([...this.#t.actionExecutor.bRegMap.entries()].map(([t,r])=>[t,{pointer:r.pointer,bits:r.getBits()}]))}async getURegMap(){return new Map([...this.#t.actionExecutor.uRegMap.entries()].map(([t,r])=>[t,r.getValue()]))}async getStateMap(){return this.#t.getStateMap()}async getNextCommandText(){return this.#t.getNextCommand()?.command.pretty()}async getB2D(){let t=this.#t.actionExecutor.b2d;return{x:t.x,y:t.y,maxX:t.getMaxX(),maxY:t.getMaxY(),data:t.getArray()}}async getOutput(){return this.#t.actionExecutor.output.getString()}async getStateStats(){return this.#t.getStateStats()}async getStates(){return this.#t.states}async getCurrentStateIndex(){return this.#t.currentStateIndex}async getInfo(){return{currentState:this.#t.getCurrentState(),previousOutput:this.#t.getPreviousOutput(),stepCount:this.#t.stepCount}}async getCurrentState(){return this.#t.getCurrentState()}async getPreviousOutput(){return this.#t.getPreviousOutput()}async getAnalyzeResult(){return this.#t.analyzeResult}async getAddSubMulToUIString(){return this.#t.actionExecutor.addSubMulToUIString()}async exec(t,r,n,s){return this.#t.exec(t,r,n,s)}};zt.expose(new Te);export{Te as MachineWorker};
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
//# sourceMappingURL=machine-worker.js.map
