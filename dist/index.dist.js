var rs=Object.defineProperty;var ns=(e,t)=>{for(var r in t)rs(e,r,{get:t[r],enumerable:!0})};var f=(e,t)=>{let r=document.querySelector(e);if(r==null)throw Error(`can't found a element for "${e}"`);if(r instanceof t)return r;throw Error(`"${e}" is not a ${t.name}`)};function d(e,t=void 0){let r=document.createElement(e);if(typeof t=="string")r.textContent=t;else if(t!=null&&typeof t=="object"&&(t.text&&(r.textContent=t.text),t.classes&&r.classList.add(...t.classes),t.fn&&(t.fn(r),t.fn=void 0),t.children&&r.append(...t.children),t.style))for(let[n,s]of Object.entries(t.style))n in r.style?r.style[n]=s:r.style.setProperty(n,s);return r}var jt=class{#t=0;#n=-1;#e=!1;#i=0;#s=0;constructor(t,{frequency:r,signal:n}){this.#i=r;let s=requestAnimationFrame,i=o=>{if(this.#e&&this.#n!==-1){let a=o-this.#n,c=this.#t,u=c+a/1e3*this.#i,p=Math.floor(u)-Math.floor(c);this.#t=u,t(p)}this.#n=o,this.#s=s(i)};this.#s=s(i),n?.addEventListener("abort",()=>{this.abort()})}abort(){this.#s!==0&&cancelAnimationFrame(this.#s)}get frequency(){return this.#i}set frequency(t){this.#i=t}get disabled(){return!this.#e}set disabled(t){this.#e=!t}reset(){this.#t=0}};var Re=e=>e instanceof Error?e.message:"Unknown error is occurred.";function*Ar(e,t){if(!Number.isInteger(t))throw RangeError("size is not an integer");let r=[];for(let n of e)r.push(n),t<=r.length&&(yield r,r=[]);r.length!==0&&(yield r)}var Dr=()=>{let e=document.createElement("span");return e.classList.add("spinner-border","spinner-border-sm"),e.setAttribute("role","status"),e.setAttribute("aria-hidden","true"),e};var l=()=>{throw Error("internal error")};var vr=(e,t,r,n)=>{let s=e.canvas.width,i=e.canvas.height;s!==i&&(e.canvas.height=s),e.reset?e.reset():(e.clearRect(0,0,s,s),e.resetTransform(),e.beginPath());let o=t.maxX,a=t.maxY,c=Math.max(o,a)+1,u=s/c;n||(e.scale(1,-1),e.translate(0,-s));let p=t.data;e.fillStyle="#212529";for(let h=0;h<=a;h++){let m=p[h]??l(),g=h*u;for(let $=0;$<=o;$++)m[$]===1&&e.rect($*u,g,u,u)}e.fill(),r||(e.strokeStyle="#03A9F4",e.lineWidth=4,e.strokeRect(t.x*u,t.y*u,u,u))};var ss=e=>{if(window.innerWidth<768)return e===9?e:8;let r=12;return r+1<=e&&e<=r+2?e:r},is=e=>d("th",{text:`U${e}`,classes:["text-end"]}),os=(e,t)=>d("td",{text:t.toString(),fn:r=>{r.dataset.test=`U${e}`},classes:["text-end"]}),as=e=>{let t=[],r=[],n=ss(e.size);for(let i of Ar(e,n)){let o=d("tr"),a=d("tr");for(let[c,u]of i){o.append(is(c));let p=os(c,u);t.push(p),a.append(p)}r.push({header:o,data:a})}let s=d("table");for(let i of r)s.append(i.header,i.data);return s.classList.add("table"),s.style.tableLayout="fixed",s.style.marginBottom="0",{table:s,cells:t}},Xt=class{constructor(t){this.root=t,this.cells=[]}initialize(t){let{table:r,cells:n}=as(t);this.root.replaceChildren(r),this.cells=n}clear(){this.cells=[],this.root.innerHTML=""}render(t){let r=0,n=this.cells;for(let s of t.values()){let i=n[r]??l();i.textContent=s.toString(),r++}}};var qt=e=>{let t="";for(let r=e.length-1;r>=0;r--)t+=e[r]===0?"0":"1";return t},Me=e=>{let t="",r=e.length;for(let n=0;n<r;n++)t+=e[n]===0?"0":"1";return t},cs=typeof BigInt<"u";function Le(e,t){return(cs?BigInt:Number)("0b"+qt(e)).toString(t)}var us=()=>{let e=d("span",{classes:["decimal"]}),t=d("span",{classes:["hex"]}),r=d("span",{classes:["max_pointer"]}),n=d("span",{classes:["pointer"]});return{metaData:d("code",{classes:["binary_info","word-break-all"],children:[e,t,r,n]}),$decimal:e,$hex:t,$maxPointer:r,$pointer:n}},ls=()=>{let e=d("span",{classes:["prefix"]}),t=d("span",{classes:["binary-head"]}),r=d("span",{classes:["suffix"]});return{binaryBits:d("code",{classes:["word-break-all"],children:[e,t,r]}),$prefix:e,$head:t,$suffix:r}},Kt=class{constructor(t){this.root=t,this.cells=[]}initialize(t){this.clear();let r=[],n=d("table");for(let s of t.keys()){let i=d("td");i.dataset.test=`B${s}`;let{metaData:o,$decimal:a,$hex:c,$maxPointer:u,$pointer:p}=us();i.append(o,d("br"));let{binaryBits:h,$prefix:m,$head:g,$suffix:$}=ls();i.append(h);let A=d("tr",{children:[d("th",`B${s}`),i]});n.append(A),r.push({$decimal:a,$hex:c,$maxPointer:u,$pointer:p,$prefix:m,$head:g,$suffix:$})}this.root.append(n),this.cells=r}clear(){this.cells=[],this.root.innerHTML=""}render(t,r,n,s,i){let o=0,a=this.cells;for(let c of t.values()){let{$prefix:u,$head:p,$suffix:h,$decimal:m,$hex:g,$maxPointer:$,$pointer:A}=a[o]??l();if(r)u.innerHTML="",p.innerHTML="",h.innerHTML="";else{let _=ps(c);u.textContent=n?qt(_.suffix):Me(_.prefix),p.textContent=_.head.toString(),h.textContent=n?qt(_.prefix):Me(_.suffix)}s?m.textContent="value = "+Le(c.bits,10)+", ":m.innerHTML="",i?g.textContent="hex = "+Le(c.bits,16)+", ":g.innerHTML="",$.textContent="max_pointer = "+(c.bits.length-1)+", ",A.textContent="pointer = "+c.pointer.toString(),o++}}};function ps(e){let t=e.bits,r=e.pointer;return{prefix:t.slice(0,r),head:t[r]??l(),suffix:t.slice(r+1)}}var D=e=>e.toLocaleString();var Rr="stats_current_state",fs=(e,{z:t,nz:r})=>{let n=d("td",{fn:u=>{u.colSpan=2},children:[d("code",e)]}),s="num",i=d("td",{text:D(t+r),classes:[s]}),o=d("td",{text:D(t),classes:[s]}),a=d("td",{text:D(r),classes:[s]});return{$tr:d("tr",{children:[n,i,o,a]}),$sum:i,$z:o,$nz:a}},Qt=class{#t;constructor(t,r){this.root=t,this.#t=r,this.cells=[]}initialize(t,r){this.#t.textContent=D(r.length),this.cells=[],this.root.innerHTML="";for(let[n,s]of t.entries()){let i=r[n]??"",{$tr:o,$sum:a,$z:c,$nz:u}=fs(i,s);this.root.append(o),this.cells.push({$sum:a,$z:c,$nz:u,$tr:o})}}clear(){this.#t.innerHTML="",this.cells=[],this.root.innerHTML=""}render(t,r){let n=t,s=this.cells,i=s.length;for(let o=0;o<i;o++){let a=s[o]??l();r===o?a.$tr.classList.add(Rr):a.$tr.classList.remove(Rr);let{z:c,nz:u}=n[o]??l();a.$sum.textContent=D(c+u),a.$z.textContent=D(c),a.$nz.textContent=D(u)}}};function Mr(e,t){if(e.innerHTML="",t===void 0)return;let r=d("option","None");r.value="-1",r.selected=!0,e.append(r);for(let[n,s]of t){let i=d("option",n);i.value=s.toString(),e.append(i)}}function Lr(e){switch(e.value){case"*":return-1;case"Z":return 0;default:return 1}}var ds="Start",ms="Stop",kr="btn-primary",Ur="btn-danger",Or=e=>`<svg width="16" height="16" viewBox="0 0 16 16">${e}</svg>`,hs=()=>{let e=d("div");return e.innerHTML=Or('<path stroke="currentColor" stroke-width="1" d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>')+ds,e},gs=hs(),ys=()=>{let e=d("div");return e.innerHTML=Or('<path stroke="currentColor" stroke-width="1" d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z"/>')+ms,e},xs=ys();function _t(e){e.disabled=!1,e.replaceChildren(gs),e.classList.add(kr),e.classList.remove(Ur)}function Pr(e){e.disabled=!1,e.replaceChildren(xs),e.classList.remove(kr),e.classList.add(Ur)}function Hr(e,t,r){if(e.replaceChildren(),t==="RuntimeError"||t==="ParseError"){let n=r.split(`
`);for(let s of n)e.append(d("span","- "+s),d("br"));e.classList.remove("d-none")}else e.classList.add("d-none")}var Ct=40,Jt=window.innerWidth;Jt>=1200?Ct=120:Jt>=992?Ct=100:Jt>=768?Ct=70:Jt>=576&&(Ct=50);var zr=(e,t)=>{if(t=t??"",e.value===t)return;e.value=t;let r=t.length,s=Math.min(6,Math.max(1,Math.ceil(r/Ct)));e.rows=s};var bs=()=>{let e=[];for(let r=0;r<=6;r++)for(let n of[1,...r===0?[]:[1.5],2,3,5,8])e.push(n*10**r);return e.push(10*10**6,15*10**6,20*10**6,100*10**6),e.map(r=>Math.floor(r))};function Fr(e,t){let r=bs();e.min="0",e.max=(r.length-1).toString();function n(){console.log(e.value);let s=parseInt(e.value,10),i=r[s]??l();e.ariaValueText=`(${i.toString()}Hz)`,t.setFrequency(i)}e.addEventListener("input",()=>{n()}),setTimeout(()=>{n()},1)}var Gr=(e,t)=>{e.setCustomValidity(t),e.reportValidity(),e.classList.add("is-invalid")},Vr=e=>{e.setCustomValidity(""),e.reportValidity(),e.classList.remove("is-invalid")};function Wr(e,t){e.addEventListener("input",()=>{let r=e.files?.item(0);r?.text().then(t)})}var te=window.requestIdleCallback??(e=>{setTimeout(()=>{e({didTimeout:!1,timeRemaining(){return 0}})},0)});function lt(e,t){try{localStorage.setItem(e,t)}catch{}}function ee(e){try{localStorage.removeItem(e)}catch{}}function pt(e){try{return localStorage.getItem(e)}catch{return null}}function ft(e,t){try{let r=pt(e);r!=null&&(ee(e),lt(t,r))}catch{}}var Ss=new Set(["textarea","input","summary","details","button","audio","video","select","option","a","area","modal"]),Yr=()=>{let e=document.activeElement?.tagName.toLowerCase()??"";return Ss.has(e)};var x=HTMLElement,L=HTMLInputElement,U=HTMLButtonElement,Zr=f("#error",x),k=f("#input",HTMLTextAreaElement),jr=f("#output_detail",x),Xr=f("#output",HTMLTextAreaElement),qr=f("#steps",x),v=f("#toggle",U),O=f("#reset",U),R=f("#step",U),re=f("#step-text",x),Kr=f("#config_button",U),dt=f("#stats_button",U),Qr=f("#current_state",x),Jr=f("#previous_output",x),tn=f("#frequency_input",L),en=f("#frequency_output",x),rn=f("#command",x),ne=f("#canvas",HTMLCanvasElement),se=ne.getContext("2d")??(()=>{throw Error("context is null")})(),Bt={x:f("#b2dx",x),y:f("#b2dy",x)},mt=f("#b2d_detail",HTMLDetailsElement),nn=f("#unary_register",x),It=f("#unary_register_detail",HTMLDetailsElement),sn=f("#binary_register",x),At=f("#binary_register_detail",HTMLDetailsElement),on=f("#add_sub_mul_detail",x),an=f("#add_sub_mul",x),cn=f("#import_file",L),ie=f("#examples",U),un=document.querySelectorAll(".js_example"),ke=f("#config_modal_content",x),Dt=f("#step_input",L),T={$hideBits:f("#hide_bits",L),$reverseBits:f("#reverse_bits",L),$showBinaryValueInDecimal:f("#show_binary_value_in_decimal",L),$showBinaryValueInHex:f("#show_binary_value_in_hex",L)},Ue=f("#breakpoint_select",HTMLSelectElement),ln=f("#breakpoint_input_select",HTMLSelectElement),vt=f("#dark_mode",L),Oe=f("#dark_mode_label",x),oe=f("#b2d_hide_pointer",L),Rt=f("#b2d_flip_upside_down",L),ae=f("#stats_modal",x),pn=f("#stats_body",x),fn=f("#stats_number_of_states",x),dn=f("#view-state-diagram",U),mn=f("#add-library-file",U),hn=f("#library-list",x),Pe=f('#library_modal [data-bs-dismiss="modal"]',x),ce=f("#add-binary-library-file",U);function Es(e,t){let r=document.createElement("input");r.type="file",r.style.display="none",e.addEventListener("click",()=>{r.click()}),r.addEventListener("change",n=>{let s=n.target.files;if(s.length>0){let i=s[0];t(i)}}),document.body.appendChild(r)}var ue=class{constructor(){this.files=[]}getFiles(){return this.files.slice()}initialize(){ce.addEventListener("click",async()=>{ce.disabled=!0,this.addFile({name:"binary.apglib",content:await fetch("./frontend/data/binary.apglib").then(t=>t.text()),builtin:!0}),await new Promise(t=>setTimeout(t,500)),Pe.click()}),Es(mn,async t=>{this.addFile({name:t.name,content:await t.text()}),await new Promise(r=>setTimeout(r,500)),Pe.click()})}addFile(t){this.files.push(t);let r=d("td");r.textContent=t.name;let n=d("button",{text:"Delete"});n.className="btn btn-danger btn-sm",n.addEventListener("click",()=>{t.builtin&&(ce.disabled=!1),this.files=this.files.filter(o=>o.name!==t.name),i.remove()});let s=d("td",{children:[n]}),i=d("tr",{children:[r,s]});hn.append(i)}};var y=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var He="A1",ze="B0",Fe="B1",gn="ADD",ws=e=>{switch(e){case 0:return He;case 1:return ze;case 2:return Fe}},$s=e=>{switch(e){case He:return 0;case ze:return 1;case Fe:return 2}},B=class e extends y{constructor(t){super(),this.op=t}pretty(){return`${gn} ${ws(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===gn&&(s===He||s===ze||s===Fe))return new e($s(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var le="INC",Ge="TDEC",pe="READ",fe="SET",Ve="B2DX",We="B2DY",Ye="B2D",Ts="DEC",yn="SQX",xn="SQY",bn="SQ",Sn=e=>{switch(e){case le:return 0;case Ge:return 1;case pe:return 2;case fe:return 3}},Ns=e=>{switch(e){case 0:return le;case 1:return Ge;case 2:return pe;case 3:return fe}},En=e=>{switch(e){case Ve:return 4;case We:return 5;case Ye:return 6}},_s=e=>{switch(e){case 4:return Ve;case 5:return We;case 6:return Ye}},Y=class e extends y{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${Ns(this.op)} ${_s(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)){if(n===le||n===Ge){if(s===Ve||s===We)return new e(Sn(n),En(s))}else if((n===pe||n===fe)&&s===Ye)return new e(Sn(n),En(s));switch(n){case le:switch(s){case yn:return new e(0,4);case xn:return new e(0,5);default:return}case Ts:switch(s){case yn:return new e(1,4);case xn:return new e(1,5);default:return}case pe:switch(s){case bn:return new e(2,6);default:return}case fe:switch(s){case bn:return new e(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof e){let r=this.axis,n=t.axis;return r===4&&n===5?!1:!(r===5&&n===4)}return!1}};var Ze="INC",je="TDEC",Xe="READ",qe="SET",wn="B",Cs=e=>{switch(e){case 0:return Ze;case 1:return je;case 2:return Xe;case 3:return qe}},Bs=e=>{switch(e){case Ze:return 0;case je:return 1;case Xe:return 2;case qe:return 3}},S=class e extends y{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Cs(this.op)} ${wn}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===Ze||n===je||n===Xe||n===qe)&&s.startsWith(wn)){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(Bs(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var $n="HALT_OUT",Tn="HALT",w=class e extends y{constructor(t=!0){super(),this.output=t}pretty(){return this.output?$n:Tn}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===$n)return new e(!0);if(n===Tn)return new e(!1)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var Ke="0",Qe="1",Nn="MUL",Is=e=>{switch(e){case Ke:return 0;case Qe:return 1}},As=e=>{switch(e){case 0:return Ke;case 1:return Qe}},Z=class e extends y{constructor(t){super(),this.op=t}pretty(){return`${Nn} ${As(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Nn&&(s===Ke||s===Qe))return new e(Is(s))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var _n="NOP",nt=class e extends y{constructor(){super()}pretty(){return _n}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===_n)return new e}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var Cn="OUTPUT",j=class e extends y{constructor(t){super(),this.digit=t}pretty(){return`${Cn} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Cn&&s!==void 0)return new e(s)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var Je="A1",tr="B0",er="B1",Bn="SUB",Ds=e=>{switch(e){case 0:return Je;case 1:return tr;case 2:return er}},vs=e=>{switch(e){case Je:return 0;case tr:return 1;case er:return 2}},X=class e extends y{constructor(t){super(),this.op=t}pretty(){return`${Bn} ${Ds(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Bn&&(s===Je||s===tr||s===er))return new e(vs(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var rr="INC",nr="TDEC",In="U",Rs="R",Ms=e=>{switch(e){case 0:return rr;case 1:return nr}},Ls=e=>{switch(e){case rr:return 0;case nr:return 1}},E=class e extends y{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Ms(this.op)} ${In}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===rr||n===nr)&&(s.startsWith(In)||s.startsWith(Rs))){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(Ls(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var sr="INC",ir="DEC",or="READ",ar="SET",cr="RESET",ks=e=>{switch(e){case 0:return sr;case 1:return ir;case 2:return or;case 3:return ar;case 4:return cr}},Us=e=>{switch(e){case sr:return 0;case ir:return 1;case or:return 2;case ar:return 3;case cr:return 4}},q=class e extends y{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${ks(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===sr||n===ir||n===or||n===ar||n===cr)&&s.startsWith("T")){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(Us(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var he=class{constructor(){this.value=0}action(t){switch(t.op){case 1:{let r=this.value,n=r%2;return this.value=[0,0,0,0,0,0,9,9,0,0,9,9,9,9,9,9][r]??l(),n}case 2:{let r=this.value,n=1-r%2;return this.value=[0,0,0,0,9,9,0,0,9,9,0,0,9,9,9,9][r]??l(),n}case 0:{this.value=[5,4,7,6,1,0,3,2,13,12,15,14,9,8,11,10][this.value]??l();return}default:l()}}getValue(){return this.value}a1(){this.action(new B(0))}b0(){let t=this.action(new B(1));return t===void 0&&l(),t}b1(){let t=this.action(new B(2));return t===void 0&&l(),t}toString(){return this.value.toString(2).padStart(4,"0")}toStringDetail(){let t=this.toString();return`${t.slice(0,3)} bit${t.slice(3)}`}};var ur=(e,t)=>Array(e).fill(0).map((r,n)=>t(n)),ge=class{constructor(){this.x=0,this.y=0,this.maxX=0,this.maxY=0,this.array=ur(1,()=>ur(1,()=>0))}getArray(){return this.array}getMaxX(){return this.maxX}getMaxY(){return this.maxY}action(t){switch(t.op){case 0:{switch(t.axis){case 4:return this.incB2DX();case 5:return this.incB2DY();case 6:l()}break}case 1:{switch(t.axis){case 4:return this.tdecB2DX();case 5:return this.tdecB2DY();case 6:l()}break}case 2:{switch(t.axis){case 6:return this.read();default:l()}break}case 3:{switch(t.axis){case 6:return this.set();default:l()}break}default:l()}}incB2DX(){if(this.x++,this.maxX<this.x){for(let t of this.array)t.push(0);this.maxX=this.x}}incB2DY(){this.y++,this.maxY<this.y&&(this.array.push(ur(this.maxX+1,()=>0)),this.maxY=this.y)}tdecB2DX(){return this.x===0?0:(this.x--,1)}tdecB2DY(){return this.y===0?0:(this.y--,1)}read(){let t=this.array[this.y];t===void 0&&l();let r=t[this.x];return r===void 0&&l(),t[this.x]=0,r}set(){let t=this.array[this.y]??l();if(t[this.x]===1)throw Error(`SET B2D: Tried to set when it was already 1. x = ${this.x}, y = ${this.y}`);t[this.x]=1}};var ye=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.value===0?0:(this.value--,1);case 0:this.value++}}actionN(t,r){switch(t.op){case 1:{this.value-=r;break}case 0:{this.value+=r;break}}}getValue(){return this.value}setValue(t){this.value=t}inc(){this.action(new E(0,0))}tdec(){let t=this.action(new E(1,0));return t===void 0&&l(),t}setByRegistersInit(t,r){(typeof r!="number"||r<0||!Number.isInteger(r))&&K(t,r),this.setValue(r)}},K=(e,t)=>{let r=`"${e}": ${JSON.stringify(t)}`;throw Error(`Invalid #REGISTERS ${r}`)};var An=e=>[...e].map(t=>{if(t==="0")return 0;if(t==="1")return 1;throw Error(`Invalid #REGISTERS: "${e}"`)}),xe=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 1:return this.pointer===0?0:(this.pointer--,1);case 0:{let r=this.pointer+1;this.pointer=r;let n=this.bits;r===n.length&&n.push(0);break}case 2:{let r=this.pointer,n=this.bits;if(r<n.length){let s=n[r]??l();return n[r]=0,s}else return 0}case 3:{let r=this.bits,n=this.pointer;if(n>=r.length&&this.extend(),r[n]===1)throw Error(`The bit of the binary register B${t.regNumber} is already 1`);r[n]=1;break}default:{let r=t.op}}}actionN(t,r){switch(t.op){case 0:{this.pointer+=r,this.extend();break}case 1:{this.pointer-=r;break}default:throw Error("todo")}}getBits(){return this.bits}setBits(t){this.bits=t}inc(){let t=this.action(new S(0,0));return t!==void 0&&l(),t}tdec(){let t=this.action(new S(1,0));return t===void 0&&l(),t}read(){let t=this.action(new S(2,0));return t===void 0&&l(),t}set(){let t=this.action(new S(3,0));return t!==void 0&&l(),t}extend(){let t=this.pointer,r=this.bits,n=r.length;if(t>=n)if(t===n)r.push(0);else{let s=Array(t-n+1).fill(0).map(()=>0);this.bits=this.bits.concat(s)}}toObject(){this.extend();let t=this.bits,r=this.pointer;return{prefix:t.slice(0,r),head:t[r]??l(),suffix:t.slice(r+1)}}setByRegistersInit(t,r){if(typeof r=="number")this.setBits(An(r.toString(2)).reverse()),this.extend();else if(!Array.isArray(r)||r.length!==2)K(t,r);else{let[n,s]=r;if(typeof n!="number"||typeof s!="string"||n<0||!Number.isInteger(n))K(t,r);else{let i=An(s);this.pointer=n,this.setBits(i),this.extend()}}}};var be=class{constructor(){this.value=0}action(t){switch(t.op){case 0:return this.mul0();case 1:return this.mul1();default:throw Error("MUL: action")}}getValue(){return this.value}mul0(){let t=this.value,r=t%2;return this.value=t>>1,r}mul1(){let t=this.value,r=t%2;return t<=21?this.value=(t>>1)+5:this.value=t-22>>1,r}toString(){return this.value.toString(2).padStart(5,"0")}};var Se=class{constructor(){}action(){return 0}};var Ee=class{#t="";constructor(){}action(t){this.output(t.digit)}getString(){return this.#t}output(t){this.#t+=t}};var we=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.b0();case 0:return this.a1();case 2:return this.b1();default:l()}}getValue(){return this.value}a1(){let r=[3,2,-1,-1,7,6,-1,-1,11,10,-1,-1,15,14,-1,-1,19,18,-1,-1,23,22,-1,-1,27,26,-1,-1,31,30,-1,-1][this.value]??l();if(r===-1)throw Error("SUB error: A1");this.value=r}b0(){let t=this.value%2,r=[0,0,0,0,17,17,0,0,0,0,0,0,0,0,17,17,17,17,0,0,17,17,17,17,0,0,17,17,17,17,17,17];return this.value=r[this.value]??l(),t}b1(){let t=1-this.value%2,r=[17,17,0,0,0,0,0,0,0,0,17,17,0,0,0,0,17,17,17,17,17,17,0,0,17,17,17,17,0,0,17,17];return this.value=r[this.value]??l(),t}toString(){return this.value.toString(2).padStart(5,"0")}toStringDetail(){let t=this.toString();return t.slice(0,3)+" stopper"+t.slice(3,4)+" bit"+t.slice(4)}};var $e=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 0:return this.inc();case 2:return this.read();case 1:return this.dec();case 3:return this.set();case 4:return this.reset();default:l()}}getPointer(){return this.pointer}getBits(){return this.bits}inc(){let t=this.bits;return this.pointer===t.length-1?(t.push(0),this.pointer++,0):(this.pointer++,1)}dec(){return this.pointer===0?0:(this.pointer--,1)}read(){let t=this.pointer,r=this.bits,n=r[t];if(n===0)return r[t]=-1,0;if(n===1)return r[t]=-1,1;if(n===-1)throw Error("Error: reading empty space of T register");l()}set(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=1;else throw Error("Error: SET to nonempty bit")}reset(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=0;else throw Error("Error: RESET to nonempty bit")}};var Ft=(e,t)=>{throw Error(`Register ${e}${t} is not found.`)},Dn=Number.parseInt,vn=Number.isNaN,Te=class{constructor({unary:t,binary:r,legacyT:n}){this.uRegMap=new Map(t.map(s=>[s,new ye])),this.bRegMap=new Map(r.map(s=>[s,new xe])),this.legacyTRegMap=new Map(n.map(s=>[s,new $e])),this.add=new he,this.sub=new we,this.mul=new be,this.b2d=new ge,this.output=new Ee,this.nop=new Se}setByRegistersInit(t){for(let[r,n]of Object.entries(t))this.#t(r,n)}setCache(t){t instanceof S?t.registerCache=this.getBReg(t.regNumber):t instanceof E&&(t.registerCache=this.getUReg(t.regNumber))}#t(t,r){if(t.startsWith("U")){let n=Dn(t.slice(1),10);vn(n)&&K(t,r);let s=this.getUReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: U${n} isn't used in the program`);s.setByRegistersInit(t,r)}else if(t.startsWith("B")){let n=Dn(t.slice(1),10);vn(n)&&K(t,r);let s=this.getBReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: B${n} isn't used in the program`);s.setByRegistersInit(t,r)}else K(t,r)}execAction(t){if(t instanceof S)return(t.registerCache??this.bRegMap.get(t.regNumber)??Ft("B",t.regNumber)).action(t);if(t instanceof E)return(t.registerCache??this.uRegMap.get(t.regNumber)??Ft("U",t.regNumber)).action(t);if(t instanceof B)return this.add.action(t);if(t instanceof nt)return this.nop.action();if(t instanceof X)return this.sub.action(t);if(t instanceof Z)return this.mul.action(t);if(t instanceof Y)return this.b2d.action(t);if(t instanceof j)return this.output.action(t);if(t instanceof w)return-1;if(t instanceof q)return(this.legacyTRegMap.get(t.regNumber)??Ft("T",t.regNumber)).action(t);throw Error(`execAction: unknown action ${t.pretty()}`)}execActionN(t,r){if(t instanceof E)return(t.registerCache??this.uRegMap.get(t.regNumber)??Ft("U",t.regNumber)).actionN(t,r);if(t instanceof S)return(t.registerCache??this.bRegMap.get(t.regNumber)??Ft("B",t.regNumber)).actionN(t,r);if(t instanceof w)return-1;throw Error(`execActionN: ${t.pretty()}`)}getUReg(t){return this.uRegMap.get(t)}getBReg(t){return this.bRegMap.get(t)}addSubMulToUIString(){return`
        ADD = ${this.add.toStringDetail()},
        SUB = ${this.sub.toStringDetail()},
        MUL = ${this.mul.toString()}
        `}};var Os=[S.parse,E.parse,Y.parse,nt.parse,B.parse,Z.parse,X.parse,j.parse,w.parse,q.parse],lr=e=>{for(let t of Os){let r=t(e);if(r!==void 0)return r}};var N=e=>e!==void 0?` at line ${e}`:"";function pr(e,t,r,n){if(e=e.trim(),!e.startsWith("{"))return`Invalid line "${r}"${N(t)}. ${n} replacements does not start with "{"`;if(!e.endsWith("}"))return`Invalid line "${r}"${N(t)}. ${n} replacements does not end with "}"`;try{return e.slice(1,-1).slice().split(";").map(s=>{let i=s.trim().split("=").map(o=>o.trim());if(i.length!=2)throw new Error(`Invalid line "${r}"${N(t)}. #DEFINE invalid replacements`);return{needle:i[0]??l(),replacement:i[1]??l()}})}catch(s){return s instanceof Error?s.message:l()}}var Gt="INITIAL",C=class{pretty(){return""}},it=class e extends C{constructor(t){super(),this.content=t}static get key(){return"#COMPONENTS"}pretty(){return e.key+" "+this.content}},ot=class e extends C{constructor(t){super(),this.content=t}static get key(){return"#REGISTERS"}pretty(){return e.key+" "+this.content}};function Rn(e){return"{ "+e.map(t=>t.needle+" = "+t.replacement).join("; ")+" }"}var at=class e extends C{constructor(t,r){super(),this.name=t,this.defaultReplacements=r}static get key(){return"#DEFINE"}pretty(){return e.key+" "+this.name+(this.defaultReplacements.length===0?"":" "+Rn(this.defaultReplacements))}},J=class e extends C{constructor(){super()}static get key(){return"#ENDDEF"}pretty(){return e.key}},Q=class e extends C{constructor(t,r){super(),this.templateName=t,this.replacements=r}static get key(){return"#INSERT"}pretty(){return e.key+" "+this.templateName+(this.replacements.length===0?"":" "+Rn(this.replacements))}},ct=class extends C{constructor(t){super(),this.filename=t}static get key(){return"#INCLUDE"}pretty(){return Q.key+" "+this.filename}},fr=class extends C{constructor(t){super(),this.str=t}getString(){return this.str}pretty(){return this.getString()}},dr=class extends C{constructor(){super()}pretty(){return""}},Ps=e=>{switch(e){case"Z":return e;case"NZ":return e;case"ZZ":return e;case"*":return e;default:return}},wt=class extends C{constructor({state:t,input:r,nextState:n,actions:s,line:i}){super(),this.state=t,this.input=r,this.nextState=n,this.actions=s,this.line=i,this._string=`${this.state}; ${this.input};${" ".repeat(2-this.input.length)} ${this.nextState}; ${this.actions.map(o=>o.pretty()).join(", ")}`}pretty(){return this._string}},mr=(e,t)=>{let r=e.trim();if(r==="")return new dr;if(r.startsWith("#")){if(r.startsWith(it.key))return new it(r.slice(it.key.length).trim());if(r.startsWith(ot.key))return new ot(r.slice(ot.key.length).trim());if(r.startsWith(at.key)){let m=r.slice(at.key.length).trim();if(m.length===0)return`Invalid line "${e}"${N(t)}. #DEFINE needs a name.`;let g,$=[],A=m.indexOf("{");if(A!==-1){g=m.slice(0,A).trim();let _=pr(m.slice(A),t,e,"#DEFINE");if(typeof _=="string")return _;$=_}else g=m;return new at(g,$??[])}else{if(r.startsWith(J.key))return new J;if(r.startsWith(Q.key)){let m=r.slice(Q.key.length).trim();if(m.length===0)return`Invalid line "${e}"${N(t)}. #INSERT needs a name.`;let g,$=[],A=m.indexOf("{");if(A!==-1){g=m.slice(0,A).trim();let _=pr(m.slice(A),t,e,"#INSERT");if(typeof _=="string")return _;$=_}else g=m;return new Q(g,$)}else if(r.startsWith(ct.key)){let m=r.slice(ct.key.length).trim();return m===""?`Invalid line "${e}"${N(t)}. #INCLUDE needs filename.`:new ct(m)}}return new fr(e)}let s=(r.split("#")[0]??"").split(/\s*;\s*/u);if(s.length<4)return`Invalid line "${e}"${N(t)}`;if(s.length>4)return s[4]===""?`Extraneous semicolon "${e}"${N(t)}`:`Invalid line "${e}"${N(t)}`;let i=s[0]??l(),o=s[1]??l(),a=s[2]??l(),u=(s[3]??l()).trim().split(/\s*,\s*/u).filter(m=>m!==""),p=[];for(let m of u){let g=lr(m);if(g===void 0)return`Unknown action "${m}" in "${e}"${N(t)}`;p.push(g)}let h=Ps(o);return h===void 0?`Unknown input "${o}" in "${e}"${N(t)}. Expect "Z", "NZ", "ZZ" or "*"`:new wt({state:i,input:h,nextState:a,actions:p,line:t})},W=e=>N(e.line),I=e=>`"${e.pretty()}"${W(e)}`;var Mn=e=>{let t=e.actions;if(t.some(n=>n instanceof w))return;let r=t.filter(n=>n.doesReturnValue());if(r.length!==1)return r.length===0?`Does not return a value in ${I(e)}`:`Does not contain exactly one action that returns a value in "${e.pretty()}": Actions that produce value are ${r.map(n=>`"${n.pretty()}"`).join(", ")}${W(e)}`};var Ln=e=>{if(e.nextState===Gt)return`Return to initial state in ${I(e)}`};var kn=e=>{let t=e.actions;if(t.length<=1)return;let r=t.map(s=>s.pretty());r.sort();let n=r.length-1;for(let s=0;s<n;s++){let i=r[s],o=r[s+1];if(i===o)return`Duplicated actions "${i}" in ${I(e)}`}};var Un=e=>{let t=e.actions;if(t.find(n=>n instanceof w)!==void 0)return;let r=t.length;if(!(r<=1))for(let n=0;n<r;n++){let s=t[n]??l();for(let i=n+1;i<r;i++){let o=t[i]??l();if(s.isSameComponent(o))return`Actions "${s.pretty()}" and "${o.pretty()}" use same component in ${I(e)}`}}};var Hs=(e,t)=>e.line!==void 0&&t?.line!==void 0?` at line ${e.line} and ${t.line}`:"",On=e=>{if(e.length===0)return;let t=(s,i)=>`Need Z line followed by NZ line in "${s.pretty()}"${Hs(s,i)}`,r=e.length-1;for(let s=0;s<r;s++){let i=e[s]??l(),o=e[s+1]??l(),a=i.input,c=o.input;if(a==="Z"&&c!=="NZ"||c==="NZ"&&a!=="Z"||a==="Z"&&c==="NZ"&&i.state!==o.state)return[t(i,o)]}let n=e[r];if(n?.input==="Z")return[t(n)]};var tt=class e{constructor(t,r=new Map){this.templates=r,this.array=t}getArray(){return this.array}getTemplates(){return this.templates}pretty(){return this.array.map(t=>t.pretty()).join(`
`)}static parse(t){let r=t.split(/\r\n|\n|\r/u),n=[],s=[],i=new Map,o=null;for(let[a,c]of r.entries()){if(o!=null){if(c.trimStart().startsWith(J.key)&&mr(c,a+1)instanceof J){o=null;continue}let p=i.get(o);p==null&&l(),p.lines.push(c);continue}let u=mr(c,a+1);if(u instanceof at){if(o!=null)return`#DEFINE needs #ENDDEF ${u.pretty()}`;if(o=u.name,i.has(o))return`#DEFINE duplicate template name ${u.pretty()}`;i.set(o,{defaultReplacements:u.defaultReplacements,lines:[]})}else{if(u instanceof J)return`#ENDDEF needs #DEFINE ${u.pretty()}`;u instanceof C?s.push(u):typeof u=="string"?n.push(u):l()}}return o!=null&&n.push(`#DEFINE needs #ENDDEF. "${o}"`),n.length>0?n.join(`
`):new e(s,i)}};var Pn=e=>{let t=[];{let r=[kn,Mn,Un,Ln];for(let n of e)for(let s of r){let i=s(n);typeof i=="string"&&t.push(i)}}{let r=[On];for(let n of r){let s=n(e);s!==void 0&&(t=t.concat(s))}}if(t.length>0)return t.join(`
`)};function zs(e,t,r){let n=e;for(let s of r)n=n.replaceAll(s.needle,s.replacement);for(let s of t.defaultReplacements)n=n.replaceAll(s.needle,s.replacement);return n}function Hn(e,t){let r=[],n=new Map(e.getTemplates().entries()),s=e.getArray().slice().reverse();function i(o){let a=o.getArray();for(let c=a.length-1;c>=0;c--)s.push(a[c]??l());for(let[c,u]of o.getTemplates()){if(n.get(c)!=null)throw new Error(`#DEFINE duplicate template name "${c}"`);n.set(c,u)}}for(;s.length>=1;){let o=s.pop();if(o instanceof wt)r.push(o);else if(o instanceof ct){let a=t.find(c=>c.name===o.filename);if(a==null)throw new Error(`#INCLUDE file not found: "${o.filename}". Add a library file.`);i(a.programLines)}else if(o instanceof Q){let a=n.get(o.templateName);if(a==null)throw new Error(`Undefined template: "${o.templateName}" at line "${o.pretty()}"`);let c=a.lines.map(p=>zs(p,a,o.replacements)).join(`
`),u=tt.parse(c);if(typeof u=="string")throw new Error(u);i(u)}}return r}var zn="CLOCK-2^";function Gn(e){let t=[],r=e.split(",").map(n=>n.trim());for(let n of r)if(n!=="..."&&!(n==="NOP"||n==="HALT_OUT")){if(n==="OUTPUT"||n==="B2D"||n==="ADD"||n==="SUB"||n==="MUL")t.push(n);else if(n.startsWith(zn)){let s=Number(n.slice(zn.length))}else if(n.startsWith("B")){let s=Fn(n.slice(1));for(let i of s.map(o=>`B${o}`))t.push(i)}else if(n.startsWith("U")){let s=Fn(n.slice(1));for(let i of s.map(o=>`U${o}`))t.push(i)}}return t}function Fn(e){let t=e.split("-");if(t.length===1){if(t[0]?.length===0)throw new Error("Invalid #COMPONENTS");let r=Number(t[0]);if(Number.isNaN(r))throw new Error("Invalid #COMPONENTS");return[r]}else if(t.length===2){if(t.some(i=>i.length===0))throw new Error("Invalid #COMPONENTS");let[r,n]=t.map(i=>Number(i));if(r==null||n==null||Number.isNaN(r)||Number.isNaN(n))throw new Error("Invalid #COMPONENTS");let s=[];for(let i=r;i<n+1;i++)s.push(i);return s}throw new Error("Invalid #COMPONENTS")}var Vt=class e{constructor(t,r,n){this.commands=t,this.componentsHeader=r,this.registersHeader=n}static parse(t,{noValidate:r,libraryFiles:n}={}){let s=tt.parse(t);if(typeof s=="string")return s;let i=[];for(let a of n??[]){let c=tt.parse(a.content);if(typeof c=="string")return c;i.push({name:a.name,programLines:c})}let o=Hn(s,i);if(!r){if(o.length===0)return"Program is empty";let a=Pn(o);if(typeof a=="string")return a}return new e(o,s.getArray().flatMap(a=>a instanceof it?[a]:[]),s.getArray().flatMap(a=>a instanceof ot?[a]:[]))}},Fs=e=>[...new Set(e)].sort((t,r)=>t-r),hr=e=>{let t=e.commands.flatMap(c=>c.actions),r=c=>Fs(t.flatMap(u=>u instanceof c?[u.regNumber]:[])),n=!1,s=!1,i=!1,o=!1,a=!1;for(let c of t)c instanceof B?n=!0:c instanceof X?s=!0:c instanceof Z?i=!0:c instanceof Y?o=!0:c instanceof j&&(a=!0);return{unary:r(E),binary:r(S),legacyT:r(q),hasAdd:n,hasSub:s,hasMul:i,hasB2D:o,hasOutput:a}},Vn=(e,t)=>{let r=[],n=new Set(e.flatMap(o=>Gn(o.content)));t.hasAdd&&(n.has("ADD")||r.push("Program uses ADD component but the #COMPONENTS header does not include it.")),t.hasSub&&(n.has("SUB")||r.push("Program uses SUB component but the #COMPONENTS header does not include it.")),t.hasMul&&(n.has("MUL")||r.push("Program uses MUL component but the #COMPONENTS header does not include it.")),t.hasB2D&&(n.has("B2D")||r.push("Program uses B2D component but the #COMPONENTS header does not include it.")),t.hasOutput&&(n.has("OUTPUT")||r.push("Program uses OUTPUT component but the #COMPONENTS header does not include it."));let s=[];for(let o of t.unary)n.has("U"+o)||s.push(o);s.length>0&&r.push(`Program uses ${s.map(o=>"U"+o).join(", ")} component${s.length===1?"":"s"} but the #COMPONENTS header does not include it.`);let i=[];for(let o of t.binary)n.has("B"+o)||i.push(o);if(i.length>0&&r.push(`Program uses ${i.map(o=>"B"+o).join(", ")} component${i.length===1?"":"s"} but the #COMPONENTS header does not include it.`),r.length!==0)throw new Error(r.join(`
`))};var Gs=e=>e instanceof S&&e.op===0,Vs=e=>e instanceof E&&e.op===1,Ws=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof w))&&e.actions.every(t=>t instanceof E||Gs(t))){let t=e.actions.find(Vs);if(t&&t instanceof E)return{tdecU:t}}},Ys=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof w))&&e.actions.length===1&&e.actions.every(t=>t instanceof S)){let t=e.actions.find(r=>r instanceof S&&r.op===1);if(t&&t instanceof S)return{tdecB:t}}},$t=class{constructor(t,r){this.command=t,this.nextState=r,this.tdecuOptimize=Ws(t),this.tdecbOptimize=Ys(t)}},yr=class{constructor(t,r){this.z=t,this.nz=r}},gr=(e,t)=>{throw Error(`Duplicated command: "${e.pretty()}" and "${t.pretty()}"${W(t)}`)},Wn=e=>{let t=new Map,r=[];for(let n of e)t.has(n.state)||(t.set(n.state,t.size),r.push(new yr(void 0,void 0)));for(let n of e){let s=r[t.get(n.state)??l()]??l(),i=t.get(n.nextState);if(i===void 0)throw Error(`Unknown state: "${n.nextState}" at "${n.pretty()}"${W(n)}`);switch(n.input){case"Z":{s.z===void 0?s.z=new $t(n,i):gr(s.z.command,n);break}case"NZ":{s.nz===void 0?s.nz=new $t(n,i):gr(s.nz.command,n);break}case"ZZ":{if(s.nz!==void 0)throw Error(`Invalid input: ZZ with NZ or *: "${n.pretty()}" and "${s.nz.command.pretty()}"${W(n)}`);s.z===void 0?s.z=new $t(n,i):gr(s.z.command,n);break}case"*":{if(s.nz!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.nz.command.pretty()}"${W(n)}`);if(s.z!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.z.command.pretty()}"${W(n)}`);{let o=new $t(n,i);s.z=o,s.nz=o}break}default:l()}}return{states:[...t.keys()],stateMap:t,lookup:r}};var M=(e="error")=>{throw Error(e)},Wt=class e{constructor(t){this.stepCount=0;let r=hr(t);this.actionExecutor=new Te(r),this.prevOutput=0;let{states:n,stateMap:s,lookup:i}=Wn(t.commands);this.lookup=i;for(let a of i){let c=(a.z?.command.actions??[]).concat(a.nz?.command.actions??[]);for(let u of c)this.actionExecutor.setCache(u)}this.currentStateIndex=s.get(Gt)??M(`${Gt} state is not present`),this.stateStatsArray=[],this.states=n,this.stateMap=s,this.program=t,this.analyzeResult=r;for(let a=0;a<i.length*2;a++)this.stateStatsArray.push(0);let o=t.registersHeader;for(let a of o)this.#t(a);t.componentsHeader.length>0&&Vn(t.componentsHeader,r)}static fromString(t,r){let n=Vt.parse(t,{libraryFiles:r??[]});if(typeof n=="string")throw Error(n);return new e(n)}getStateStats(){let t=this.stateStatsArray,r=t.length,n=[];for(let s=0;s<r;s+=2)n.push({z:t[s]??M(),nz:t[s+1]??M()});return n}#t(t){let r=t.content.replace(/'/ug,'"'),n={};try{n=JSON.parse(r)}catch{M(`Invalid #REGISTERS: is not a valid JSON: "${r}"`)}(n===null||typeof n!="object")&&M(`Invalid #REGISTERS: "${r}" is not an object`),this.actionExecutor.setByRegistersInit(n)}getCurrentState(){let t=this.states[this.currentStateIndex];return t===void 0&&M("State name is not found"),t}getStateMap(){return this.stateMap}getPreviousOutput(){return this.prevOutput===0?"Z":"NZ"}getNextCommand(){let t=this.currentStateIndex,r=this.lookup[t];if(r===void 0&&M(`Internal Error: Next command is not found: Current state index: ${t}`),this.prevOutput===0){let s=r.z;if(s!==void 0)return s}else{let s=r.nz;if(s!==void 0)return s}M("Next command is not found: Current state = "+this.getCurrentState()+", output = "+this.getPreviousOutput())}_internalExecActionN(t,r){try{let s=this.actionExecutor;for(let i of t.actions)s.execActionN(i,r)}catch(s){if(s instanceof Error)this.#n(s);else throw s}let n=this.currentStateIndex*2+this.prevOutput;this.stateStatsArray[n]=(this.stateStatsArray[n]??0)+r,this.stepCount+=r}exec(t,r,n,s){let i=n!==-1,o=performance.now();for(let a=0;a<t;a++){let c=this.getNextCommand();if(c.tdecuOptimize){let p=c.tdecuOptimize.tdecU.registerCache?.getValue();if(p!==void 0&&p!==0){p=Math.min(p,t-a),this._internalExecActionN(c.command,p),a+=p-1;continue}}else if(c.tdecbOptimize){let p=c.tdecbOptimize.tdecB.registerCache?.pointer;if(p!==void 0&&p!==0){p=Math.min(p,t-a),this._internalExecActionN(c.command,p),a+=p-1;continue}}try{if(this.execCommandFor(c)===-1)return"Halted"}catch(u){if(u instanceof Error)this.#n(u);else throw u}if(i&&this.currentStateIndex===n&&(s===-1||s===this.prevOutput))return"Stop";if(r&&(a+1)%5e5===0&&performance.now()-o>=50)return}}#n(t){let r=this.getNextCommand().command;return M(t.message+" in "+I(r))}execCommandFor(t){this.stepCount+=1;{let o=this.currentStateIndex,a=this.prevOutput,c=o*2+a;this.stateStatsArray[c]=(this.stateStatsArray[c]??0)+1}let r=-1,n=this.actionExecutor,s=t.command;for(let o of s.actions){let a=n.execAction(o);if(a===-1)return-1;a!==void 0&&(r===-1?r=a:M(`Return value twice: line = ${I(s)}`))}r===-1&&M(`No return value: line = ${I(s)}`);let i=t.nextState;this.currentStateIndex=i,this.prevOutput=r}execCommand(){return this.execCommandFor(this.getNextCommand())}};var Nt={};ns(Nt,{createEndpoint:()=>Zn,expose:()=>Er,finalizer:()=>_e,proxy:()=>es,proxyMarker:()=>br,releaseProxy:()=>jn,transfer:()=>ts,transferHandlers:()=>Sr,windowEndpoint:()=>ti,wrap:()=>Kn});var br=Symbol("Comlink.proxy"),Zn=Symbol("Comlink.endpoint"),jn=Symbol("Comlink.releaseProxy"),_e=Symbol("Comlink.finalizer"),Ce=Symbol("Comlink.thrown"),Xn=e=>typeof e=="object"&&e!==null||typeof e=="function",Zs={canHandle:e=>Xn(e)&&e[br],serialize(e){let{port1:t,port2:r}=new MessageChannel;return Er(e,t),[r,[r]]},deserialize(e){return e.start(),Kn(e)}},js={canHandle:e=>Xn(e)&&Ce in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},Sr=new Map([["proxy",Zs],["throw",js]]);function Xs(e,t){for(let r of e)if(t===r||r==="*"||r instanceof RegExp&&r.test(t))return!0;return!1}function Er(e,t=globalThis,r=["*"]){t.addEventListener("message",function n(s){if(!s||!s.data)return;if(!Xs(r,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}let{id:i,type:o,path:a}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(ut),u;try{let p=a.slice(0,-1).reduce((m,g)=>m[g],e),h=a.reduce((m,g)=>m[g],e);switch(o){case"GET":u=h;break;case"SET":p[a.slice(-1)[0]]=ut(s.data.value),u=!0;break;case"APPLY":u=h.apply(p,c);break;case"CONSTRUCT":{let m=new h(...c);u=es(m)}break;case"ENDPOINT":{let{port1:m,port2:g}=new MessageChannel;Er(e,g),u=ts(m,[m])}break;case"RELEASE":u=void 0;break;default:return}}catch(p){u={value:p,[Ce]:0}}Promise.resolve(u).catch(p=>({value:p,[Ce]:0})).then(p=>{let[h,m]=Ae(p);t.postMessage(Object.assign(Object.assign({},h),{id:i}),m),o==="RELEASE"&&(t.removeEventListener("message",n),qn(t),_e in e&&typeof e[_e]=="function"&&e[_e]())}).catch(p=>{let[h,m]=Ae({value:new TypeError("Unserializable return value"),[Ce]:0});t.postMessage(Object.assign(Object.assign({},h),{id:i}),m)})}),t.start&&t.start()}function qs(e){return e.constructor.name==="MessagePort"}function qn(e){qs(e)&&e.close()}function Kn(e,t){let r=new Map;return e.addEventListener("message",function(s){let{data:i}=s;if(!i||!i.id)return;let o=r.get(i.id);if(o)try{o(i)}finally{r.delete(i.id)}}),xr(e,r,[],t)}function Ne(e){if(e)throw new Error("Proxy has been released and is not useable")}function Qn(e){return Tt(e,new Map,{type:"RELEASE"}).then(()=>{qn(e)})}var Be=new WeakMap,Ie="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let t=(Be.get(e)||0)-1;Be.set(e,t),t===0&&Qn(e)});function Ks(e,t){let r=(Be.get(t)||0)+1;Be.set(t,r),Ie&&Ie.register(e,t,e)}function Qs(e){Ie&&Ie.unregister(e)}function xr(e,t,r=[],n=function(){}){let s=!1,i=new Proxy(n,{get(o,a){if(Ne(s),a===jn)return()=>{Qs(i),Qn(e),t.clear(),s=!0};if(a==="then"){if(r.length===0)return{then:()=>i};let c=Tt(e,t,{type:"GET",path:r.map(u=>u.toString())}).then(ut);return c.then.bind(c)}return xr(e,t,[...r,a])},set(o,a,c){Ne(s);let[u,p]=Ae(c);return Tt(e,t,{type:"SET",path:[...r,a].map(h=>h.toString()),value:u},p).then(ut)},apply(o,a,c){Ne(s);let u=r[r.length-1];if(u===Zn)return Tt(e,t,{type:"ENDPOINT"}).then(ut);if(u==="bind")return xr(e,t,r.slice(0,-1));let[p,h]=Yn(c);return Tt(e,t,{type:"APPLY",path:r.map(m=>m.toString()),argumentList:p},h).then(ut)},construct(o,a){Ne(s);let[c,u]=Yn(a);return Tt(e,t,{type:"CONSTRUCT",path:r.map(p=>p.toString()),argumentList:c},u).then(ut)}});return Ks(i,e),i}function Js(e){return Array.prototype.concat.apply([],e)}function Yn(e){let t=e.map(Ae);return[t.map(r=>r[0]),Js(t.map(r=>r[1]))]}var Jn=new WeakMap;function ts(e,t){return Jn.set(e,t),e}function es(e){return Object.assign(e,{[br]:!0})}function ti(e,t=globalThis,r="*"){return{postMessage:(n,s)=>e.postMessage(n,r,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function Ae(e){for(let[t,r]of Sr)if(r.canHandle(e)){let[n,s]=r.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},Jn.get(e)||[]]}function ut(e){switch(e.type){case"HANDLER":return Sr.get(e.name).deserialize(e.value);case"RAW":return e.value}}function Tt(e,t,r,n){return new Promise(s=>{let i=ei();t.set(i,s),e.start&&e.start(),e.postMessage(Object.assign({id:i},r),n)})}function ei(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var wr=class{#t;async init(t,r){this.#t=Wt.fromString(t,r)}async terminate(){this.terminate()}async getBRegMap(){return new Map([...this.#t.actionExecutor.bRegMap.entries()].map(([t,r])=>[t,{pointer:r.pointer,bits:r.getBits()}]))}async getURegMap(){return new Map([...this.#t.actionExecutor.uRegMap.entries()].map(([t,r])=>[t,r.getValue()]))}async getStateMap(){return this.#t.getStateMap()}async getNextCommandText(){return this.#t.getNextCommand()?.command.pretty()}async getB2D(){let t=this.#t.actionExecutor.b2d;return{x:t.x,y:t.y,maxX:t.getMaxX(),maxY:t.getMaxY(),data:t.getArray()}}async getOutput(){return this.#t.actionExecutor.output.getString()}async getStateStats(){return this.#t.getStateStats()}async getStates(){return this.#t.states}async getCurrentStateIndex(){return this.#t.currentStateIndex}async getInfo(){return{currentState:this.#t.getCurrentState(),previousOutput:this.#t.getPreviousOutput(),stepCount:this.#t.stepCount}}async getCurrentState(){return this.#t.getCurrentState()}async getPreviousOutput(){return this.#t.getPreviousOutput()}async getAnalyzeResult(){return this.#t.analyzeResult}async getAddSubMulToUIString(){return this.#t.actionExecutor.addSubMulToUIString()}async exec(t,r,n,s){return this.#t.exec(t,r,n,s)}};Nt.expose(new wr);var ri=30,De=class{#t;#n="";#e;#i;#s=new Xt(nn);#c=new Kt(sn);#a=new Qt(pn,fn);$libraryUI=new ue;#o;#r="Initial";constructor(){this.stepConfig=1,this.#o=new jt(t=>{this.run(t)},{frequency:ri}),this.$libraryUI.initialize()}setFrequency(t){this.#o.frequency=t,this.#u()}async start(){switch(this.#r){case"Initial":{await this.reset()&&(this.#r="Running");break}case"Stop":{this.#r="Running";break}default:throw Error("start: unreachable")}await this.render()}async stop(){this.#r="Stop",await this.render()}async toggle(){this.#r==="Running"?this.stop():await this.start()}async#l(){this.#e===void 0?this.#s.clear():this.#s.initialize(await this.#e.getURegMap())}async#p(){this.#e===void 0?this.#c.clear():this.#c.initialize(await this.#e.getBRegMap())}async#f(){await this.#l(),await this.#p(),await this.#h(),Mr(Ue,await this.#e?.getStateMap())}doStep(){if(this.#r==="Running"&&this.stop(),this.stepConfig>=5e6){let t=Dr();t.style.position="absolute",R.append(t),re.style.color="transparent",R.disabled=!0,O.disabled=!0,v.disabled=!0,setTimeout(()=>{try{this.run(this.stepConfig)}finally{re.style.color="",t.remove()}},33)}else this.run(this.stepConfig)}setInputAndReset(t){k.value=t,this.reset()}async reset(){if(this.#n="",this.#e)try{await this.#e.terminate()}catch(t){console.error(t)}this.#e=void 0,this.#o.reset();try{let t=this.$libraryUI.getFiles();this.#e=Nt.wrap(new Worker("./dist/machine-worker.js",{type:"module"})),await this.#e?.init(k.value,t),await this.#f(),this.#r="Stop"}catch(t){return this.#r="ParseError",this.#n=Re(t),await this.render(),!1}return this.render(),!0}#u(){let t=this.#o.frequency;this.#i!==t&&(en.textContent=D(t),this.#i=t)}async#d(){try{rn.textContent=await this.#e?.getNextCommandText()??""}catch(t){console.error(t)}}async renderB2D(){if(!mt.open)return;let t=this.#e;if(t===void 0){Bt.x.textContent="0",Bt.y.textContent="0",se.clearRect(0,0,ne.width,ne.height),se.resetTransform();return}let r=await t.getB2D();Bt.x.textContent=r.x.toString(),Bt.y.textContent=r.y.toString();let n=performance.now();vr(se,r,oe.checked,Rt.checked),this.#r==="Running"&&performance.now()-n>=200&&(mt.open=!1)}async renderUnary(){this.#e!==void 0&&It.open&&this.#s.render(await this.#e.getURegMap())}async renderBinary(){this.#e!==void 0&&At.open&&this.#c.render(await this.#e.getBRegMap(),T.$hideBits.checked,T.$reverseBits.checked,T.$showBinaryValueInDecimal.checked,T.$showBinaryValueInHex.checked)}async#m(){let t=await this.#e?.getOutput();zr(Xr,t)}async#h(){this.#e===void 0?this.#a.clear():this.#a.initialize(await this.#e.getStateStats(),await this.#e.getStates())}async renderStats(){if(!ae.classList.contains("show"))return;let t=this.#e;if(t===void 0){this.#a.clear();return}this.#a.render(await t.getStateStats(),await t.getCurrentStateIndex())}#g(){switch(this.#r){case"Initial":{_t(v),R.disabled=!1,O.disabled=!1,dt.disabled=!0;break}case"Stop":{_t(v),R.disabled=!1,O.disabled=!1,dt.disabled=!1;break}case"Running":{Pr(v),R.disabled=!0,O.disabled=!0,dt.disabled=!1;break}case"RuntimeError":case"ParseError":{_t(v),v.disabled=!0,R.disabled=!0,O.disabled=!1,dt.disabled=!0;break}case"Halted":{_t(v),v.disabled=!0,R.disabled=!0,O.disabled=!1,dt.disabled=!1;break}}}async render(){let t=this.#e,r=this.#r;if(this.#o.disabled=r!=="Running",this.#t!==r||r==="Stop"){this.#g(),r==="ParseError"?k.classList.add("is-invalid"):k.classList.remove("is-invalid");let i=await t?.getAnalyzeResult();It.style.display=i==null||i.unary.length===0?"none":"",At.style.display=i==null||i.binary.length===0?"none":"",on.style.display=i?.hasAdd||i?.hasSub||i?.hasMul?"":"none",mt.style.display=i?.hasB2D?"":"none",jr.style.display=i?.hasOutput?"":"none"}Hr(Zr,r,this.#n),this.#u();let n=await t?.getInfo();Qr.textContent=n?.currentState??"",Jr.textContent=n?.previousOutput??"",qr.textContent=n?.stepCount.toLocaleString()??"";let s=this.stepConfig;re.textContent=s===1?"Step":`${D(s)} Steps`,await this.#d(),await this.#m(),await this.renderUnary(),await this.renderBinary(),an.textContent=await t?.getAddSubMulToUIString()??"",await this.renderB2D(),await this.renderStats(),this.#t=r}async run(t){switch(this.#r){case"Initial":if(!this.reset())return}if(t<=0||isNaN(t))return;let r=this.#e;if(r===void 0)return;let n=this.#r==="Running",s=parseInt(Ue.value,10),i=Lr(ln);try{let o=await r.exec(t,n,s,i);o!==void 0&&(this.#r=o)}catch(o){this.#r="RuntimeError",this.#n=Re(o)}finally{await this.render()}}};var ni="./frontend/data/",b=new De;O.addEventListener("click",()=>{b.reset()});v.addEventListener("click",()=>{b.toggle()});R.addEventListener("click",()=>{b.doStep()});un.forEach(e=>{e.addEventListener("click",async()=>{ie.style.opacity="0.5";let t=e.dataset.src;try{let r=await fetch(ni+t);if(!r.ok)throw Error("error");b.setInputAndReset(await r.text()),Ir()}catch(r){throw r}finally{ie.removeAttribute("style")}})});Fr(tn,b);mt.addEventListener("toggle",()=>{b.renderB2D()});At.addEventListener("toggle",()=>{b.renderBinary()});It.addEventListener("toggle",()=>{b.renderUnary()});var Ir=()=>{k.scrollTop=0};Wr(cn,e=>{b.setInputAndReset(e),Ir()});Dt.addEventListener("input",()=>{let e=Number(Dt.value);isNaN(e)||e<=0||!Number.isInteger(e)?(Gr(Dt,"Enter a positive integer"),b.stepConfig=1):(Vr(Dt),b.stepConfig=e),b.render()});var Zt=(e,t)=>{e.addEventListener("change",()=>{b.render(),lt(t,e.checked.toString())})},$r="apge_hide_binary";Zt(T.$hideBits,$r);var Tr="apge_reverse_binary";Zt(T.$reverseBits,Tr);var Yt="apge_show_binary_in_decimal";Zt(T.$showBinaryValueInDecimal,Yt);var Nr="apge_show_binary_in_hex";Zt(T.$showBinaryValueInHex,Nr);oe.addEventListener("change",()=>{b.renderB2D()});var _r="apge_b2d_flip_upside_down";Zt(Rt,_r);ae.addEventListener("shown.bs.modal",()=>{b.renderStats()});dn.addEventListener("click",()=>{k.value.length>=10**6||(lt("state-diagram-input",k.value),window.open("./tools/diagram/index.html",void 0,"noreferrer=yes,noopener=yes"))});var Cr="apge_dark",ve="on",Br="dark_mode";vt.addEventListener("change",()=>{vt.checked?(lt(Br,ve),document.body.setAttribute(Cr,ve)):(ee(Br),document.body.removeAttribute(Cr)),Oe.textContent=vt.checked?"On":"Off";let e="dark-mode-anim";document.body.classList.add(e),ke.classList.add(e),setTimeout(()=>{document.body.classList.remove(e),ke.classList.remove(e)},500)});document.addEventListener("keydown",e=>{if(!(Yr()||e.isComposing||e.metaKey||e.shiftKey||e.ctrlKey))switch(e.code){case"Enter":{b.toggle();break}case"Space":{R.disabled||(e.preventDefault(),b.doStep());break}}});k.addEventListener("drop",async e=>{e.preventDefault();let t=e.dataTransfer?.files.item(0);t!=null&&(b.setInputAndReset(await t.text()),Ir())});ie.disabled=!1;Kr.disabled=!1;b.render();te(()=>{let e="initial_code",t=pt(e);t!==null&&(ee(e),b.setInputAndReset(t))});te(()=>{ft("hide_binary",$r),ft("show_binary_in_decimal",Yt),ft("reverse_binary",Tr),ft("b2d_flip_upside_down",_r),ft("show_binary_in_hex",Nr),pt(Yt)===null&&lt(Yt,"true");let e=[{key:_r,checkbox:Rt},{key:Tr,checkbox:T.$reverseBits},{key:$r,checkbox:T.$hideBits},{key:Yt,checkbox:T.$showBinaryValueInDecimal},{key:Nr,checkbox:T.$showBinaryValueInHex}];for(let{key:t,checkbox:r}of e)pt(t)==="true"&&(r.checked=!0);pt(Br)===ve&&(document.body.setAttribute(Cr,ve),vt.checked=!0,Oe.textContent="On"),b.render()});"serviceWorker"in navigator&&te(async()=>{(await navigator.serviceWorker.getRegistrations()).map(t=>t.unregister())});
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
//# sourceMappingURL=index.dist.js.map
