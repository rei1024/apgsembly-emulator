var u=()=>{throw Error("internal error")};var Un=()=>{let r=[];for(let e=0;e<=6;e++)for(let n of[1,...e===0?[]:[1.5],2,3,5,8])r.push(n*10**e);return r.push(10*10**6,15*10**6,20*10**6),r.map(e=>Math.floor(e))};function $r(r,t){let e=Un();r.min="0",r.max=(e.length-1).toString();function n(){let s=parseInt(r.value,10),i=e[s]??u();r.ariaValueText=`(${i.toString()}Hz)`,t.setFrequency(i)}r.addEventListener("input",()=>{n()}),setTimeout(()=>{n()},1)}var Nr=(r,t)=>{r.setCustomValidity(t),r.reportValidity(),r.classList.add("is-invalid")},_r=r=>{r.setCustomValidity(""),r.reportValidity(),r.classList.remove("is-invalid")};function Tr(r,t){r.addEventListener("input",()=>{let e=r.files?.item(0);e?.text().then(t)})}var Kt=window.requestIdleCallback??(r=>{setTimeout(()=>{r({didTimeout:!1,timeRemaining(){return 0}})},0)});var dt=(r,t)=>{try{localStorage.setItem(r,t)}catch{}},Qt=r=>{try{localStorage.removeItem(r)}catch{}},ft=r=>{try{return localStorage.getItem(r)}catch{return null}};function mt(r,t){try{let e=ft(r);e!=null&&(Qt(r),dt(t,e))}catch{}}var On=new Set(["textarea","input","summary","details","button","audio","video","select","option","a","area","modal"]),Ir=()=>{let r=document.activeElement?.tagName.toLowerCase()??"";return On.has(r)};var p=(r,t)=>{let e=document.querySelector(r);if(e==null)throw Error(`can't found a element for "${r}"`);if(e instanceof t)return e;throw Error(`"${r}" is not a ${t.name}`)};var g=HTMLElement,U=HTMLInputElement,H=HTMLButtonElement,Br=p("#error",g),O=p("#input",HTMLTextAreaElement),Dr=p("#output_detail",g),Rr=p("#output",HTMLTextAreaElement),vr=p("#steps",g),v=p("#toggle",H),F=p("#reset",H),C=p("#step",H),Jt=p("#step-text",g),Cr=p("#config_button",H),ht=p("#stats_button",H),Ar=p("#current_state",g),Lr=p("#previous_output",g),Mr=p("#frequency_input",U),kr=p("#frequency_output",g),Ur=p("#command",g),te=p("#canvas",HTMLCanvasElement),ee=te.getContext("2d")??(()=>{throw Error("context is null")})(),re=HTMLDetailsElement,Tt={x:p("#b2dx",g),y:p("#b2dy",g)},gt=p("#b2d_detail",re),ne=p("#printer_canvas",HTMLCanvasElement),se=ne.getContext("2d")??(()=>{throw Error("context is null")})(),It={x:p("#printer_x",g),y:p("#printer_y",g)},xt=p("#printer_detail",re),Or=p("#unary_register",g),Bt=p("#unary_register_detail",re),Pr=p("#binary_register",g),Dt=p("#binary_register_detail",re),Hr=p("#add_sub_mul_detail",g),Fr=p("#add_sub_mul",g),zr=p("#import_file",U),ie=p("#examples",H),Gr=document.querySelectorAll(".js_example"),Re=p("#config_modal_content",g),Rt=p("#step_input",U),N={$hideBits:p("#hide_bits",U),$reverseBits:p("#reverse_bits",U),$showBinaryValueInDecimal:p("#show_binary_value_in_decimal",U),$showBinaryValueInHex:p("#show_binary_value_in_hex",U)},ve=p("#breakpoint_select",HTMLSelectElement),Vr=p("#breakpoint_input_select",HTMLSelectElement),vt=p("#dark_mode",U),Ce=p("#dark_mode_label",g),Ct=p("#b2d_hide_pointer",U),yt=p("#b2d_flip_upside_down",U),oe=p("#stats_modal",g),Yr=p("#stats_body",g),Wr=p("#stats_number_of_states",g),Zr=p("#view-state-diagram",H),Xr=p("#add-library-file",H),jr=p("#library-list",g),Ae=p('#library_modal [data-bs-dismiss="modal"]',g),ae=p("#add-binary-library-file",H);var x=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var Le="A1",Me="B0",ke="B1",qr="ADD",Pn=r=>{switch(r){case 0:return Le;case 1:return Me;case 2:return ke}},Hn=r=>{switch(r){case Le:return 0;case Me:return 1;case ke:return 2}},B=class r extends x{constructor(t){super(),this.op=t}pretty(){return`${qr} ${Pn(this.op)}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(n===qr&&(s===Le||s===Me||s===ke))return new r(Hn(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof r}};var At="INC",ce="TDEC",ue="READ",le="SET",Oe="B2DX",Pe="B2DY",He="B2D",zn="DEC",Kr="SQX",Qr="SQY",Jr="SQ",Ue=r=>{switch(r){case At:return 0;case ce:return 1;case ue:return 2;case le:return 3}},tn=r=>{switch(r){case 0:return At;case 1:return ce;case 2:return ue;case 3:return le}},en=r=>{switch(r){case Oe:return 4;case Pe:return 5;case He:return 6}},Gn=r=>{switch(r){case 4:return Oe;case 5:return Pe;case 6:return He}},X=class r extends x{constructor(t,e,n=0){super(),this.op=t,this.axis=e,this.kind=n}pretty(){let t=this.op;if(this.kind===1){if(t===2)throw new Error("PRINTER component cannot READ");return t===3&&this.axis===6?"PRINT":`${tn(t)} PRN${this.axis===4?"X":"Y"}`}return`${tn(t)} ${Gn(this.axis)}`}static parse(t){let e=t.trim().split(" "),n=e.length;if(e.length===1&&e[0]==="PRINT")return new r(3,6,1);if(n===2){let[o,a]=e;if((o===At||o===ce)&&(a==="PRNX"||a==="PRNY")){let c=a==="PRNX"?4:5;return new r(Ue(o),c,1)}}if(n!==2)return;let[s,i]=e;if(!(s===void 0||i===void 0)){if(s===At||s===ce){if(i===Oe||i===Pe)return new r(Ue(s),en(i))}else if((s===ue||s===le)&&i===He)return new r(Ue(s),en(i));switch(s){case At:switch(i){case Kr:return new r(0,4);case Qr:return new r(0,5);default:return}case zn:switch(i){case Kr:return new r(1,4);case Qr:return new r(1,5);default:return}case ue:return i===Jr?new r(2,6):void 0;case le:return i===Jr?new r(3,6):void 0}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof r){if(t.kind!==this.kind)return!1;let e=this.axis,n=t.axis;return e===4&&n===5?!1:!(e===5&&n===4)}return!1}};var Fe="INC",ze="TDEC",Ge="READ",Ve="SET",rn="B",Vn=r=>{switch(r){case 0:return Fe;case 1:return ze;case 2:return Ge;case 3:return Ve}},Yn=r=>{switch(r){case Fe:return 0;case ze:return 1;case Ge:return 2;case Ve:return 3}},b=class r extends x{constructor(t,e){super(),this.op=t,this.regNumber=e,this.registerCache=void 0}pretty(){return`${Vn(this.op)} ${rn}${this.regNumber}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(!(n===void 0||s===void 0)&&(n===Fe||n===ze||n===Ge||n===Ve)&&s.startsWith(rn)){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new r(Yn(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof r?this.regNumber===t.regNumber:!1}};var nn="HALT_OUT",sn="HALT",w=class r extends x{constructor(t=!0){super(),this.output=t}pretty(){return this.output?nn:sn}static parse(t){let e=t.trim().split(" ");if(e.length!==1)return;let[n]=e;if(n===nn)return new r(!0);if(n===sn)return new r(!1)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof r}};var Ye="0",We="1",on="MUL",Wn=r=>{switch(r){case Ye:return 0;case We:return 1}},Zn=r=>{switch(r){case 0:return Ye;case 1:return We}},j=class r extends x{constructor(t){super(),this.op=t}pretty(){return`${on} ${Zn(this.op)}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(n===on&&(s===Ye||s===We))return new r(Wn(s))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof r}};var an="NOP",ot=class r extends x{constructor(){super()}pretty(){return an}static parse(t){let e=t.trim().split(" ");if(e.length!==1)return;let[n]=e;if(n===an)return new r}doesReturnValue(){return!0}isSameComponent(t){return t instanceof r}};var cn="OUTPUT",q=class r extends x{constructor(t){super(),this.digit=t}pretty(){return`${cn} ${this.digit}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(n===cn&&s!==void 0)return new r(s)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof r}};var Ze="A1",Xe="B0",je="B1",un="SUB",Xn=r=>{switch(r){case 0:return Ze;case 1:return Xe;case 2:return je}},jn=r=>{switch(r){case Ze:return 0;case Xe:return 1;case je:return 2}},K=class r extends x{constructor(t){super(),this.op=t}pretty(){return`${un} ${Xn(this.op)}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(n===un&&(s===Ze||s===Xe||s===je))return new r(jn(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof r}};var qe="INC",Ke="TDEC",ln="U",qn="R",Kn=r=>{switch(r){case 0:return qe;case 1:return Ke}},Qn=r=>{switch(r){case qe:return 0;case Ke:return 1}},E=class r extends x{constructor(t,e){super(),this.op=t,this.regNumber=e,this.registerCache=void 0}pretty(){return`${Kn(this.op)} ${ln}${this.regNumber}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(!(n===void 0||s===void 0)&&(n===qe||n===Ke)&&(s.startsWith(ln)||s.startsWith(qn))){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new r(Qn(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof r?this.regNumber===t.regNumber:!1}};var Qe="INC",Je="DEC",tr="READ",er="SET",rr="RESET",Jn=r=>{switch(r){case 0:return Qe;case 1:return Je;case 2:return tr;case 3:return er;case 4:return rr}},ts=r=>{switch(r){case Qe:return 0;case Je:return 1;case tr:return 2;case er:return 3;case rr:return 4}},Q=class r extends x{constructor(t,e){super(),this.op=t,this.regNumber=e}pretty(){return`${Jn(this.op)} T${this.regNumber}`}static parse(t){let e=t.trim().split(" ");if(e.length!==2)return;let[n,s]=e;if(!(n===void 0||s===void 0)&&(n===Qe||n===Je||n===tr||n===er||n===rr)&&s.startsWith("T")){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new r(ts(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof r?this.regNumber===t.regNumber:!1}};var fe=class{constructor(){this.value=0}action(t){switch(t.op){case 1:{let e=this.value,n=e%2;return this.value=e>>>1,n}case 2:{let e=this.value,n=1-e%2;return this.value=e===1||e===2?1:0,n}case 0:{this.value=(this.value+1)%4;return}default:u()}}getValue(){return this.value}a1(){this.action(new B(0))}b0(){let t=this.action(new B(1));return t===void 0&&u(),t}b1(){let t=this.action(new B(2));return t===void 0&&u(),t}toString(){return this.value.toString(2).padStart(2,"0")}toStringDetail(){return this.toString()}};var nr=(r,t)=>Array(r).fill(0).map((e,n)=>t(n)),zt=class{constructor(){this.x=0,this.y=0,this.maxX=0,this.maxY=0,this.array=nr(1,()=>nr(1,()=>0))}getArray(){return this.array}getMaxX(){return this.maxX}getMaxY(){return this.maxY}action(t){switch(t.op){case 0:{switch(t.axis){case 4:return this.incB2DX();case 5:return this.incB2DY();case 6:u()}break}case 1:{switch(t.axis){case 4:return this.tdecB2DX();case 5:return this.tdecB2DY();case 6:u()}break}case 2:{if(t.axis===6)return this.read();u();break}case 3:{if(t.axis===6)return this.set();u();break}default:u()}}incB2DX(){let e=this.x+1;if(this.x=e,this.maxX<e){for(let n of this.array)n.push(0);this.maxX=e}}incB2DY(){let e=this.y+1;this.y=e,this.maxY<e&&(this.array.push(nr(this.maxX+1,()=>0)),this.maxY=e)}tdecB2DX(){return this.x===0?0:(this.x--,1)}tdecB2DY(){return this.y===0?0:(this.y--,1)}read(){let t=this.array[this.y];t===void 0&&u();let e=this.x,n=t[e];return n===void 0&&u(),t[e]=0,n}set(){let t=this.array[this.y]??u(),e=this.x;if(t[e]===1)throw Error(`SET B2D: Tried to set when it was already 1. x = ${e}, y = ${this.y}`);t[e]=1}};var me=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.value===0?0:(this.value--,1);case 0:{this.value++;return}}}actionN(t,e){switch(t.op){case 1:{this.value-=e;break}case 0:{this.value+=e;break}}}getValue(){return this.value}setValue(t){this.value=t}inc(){this.action(new E(0,0))}tdec(){let t=this.action(new E(1,0));return t===void 0&&u(),t}setByRegistersInit(t,e){(typeof e!="number"||e<0||!Number.isInteger(e))&&J(t,e),this.setValue(e)}},J=(r,t)=>{let e=`"${r}": ${JSON.stringify(t)}`;throw Error(`Invalid #REGISTERS ${e}`)};var pn=r=>[...r].map(t=>{if(t==="0")return 0;if(t==="1")return 1;throw Error(`Invalid #REGISTERS: "${r}"`)}),es=typeof BigInt<"u",sr=r=>{let t="";for(let e=r.length-1;e>=0;e--)t+=r[e]===0?"0":"1";return t},rs=r=>{let t="";for(let e=r.length-1;e>=0;e--)t+=r[e]===0?"0":"1";return t},ir=r=>{let t="",e=r.length;for(let n=0;n<e;n++)t+=r[n]===0?"0":"1";return t},he=class{constructor(){this.pointer=0,this.bits=new Uint8Array(1),this.length=1}action(t){switch(t.op){case 1:return this.pointer===0?0:(this.pointer--,1);case 0:{let e=this.pointer+1;this.pointer=e,e>=this.length&&this.extend();return}case 2:{let e=this.pointer;if(e<this.length){let n=this.bits,s=n[e]??u();return n[e]=0,s}else return 0}case 3:{let e=this.pointer;e>=this.length&&this.extend();let n=this.bits;if(n[e]===1)throw Error(`The bit of the binary register B${t.regNumber} is already 1`);n[e]=1;return}default:{let e=t.op;return}}}actionN(t,e){switch(t.op){case 0:{this.pointer+=e,this.pointer>=this.length&&this.extend();break}case 1:{this.pointer-=e;break}default:throw Error("todo")}}getBits(){return Array.from(this.bits.slice(0,this.length))}getLength(){return this.length}setBits(t){this.length=t.length,this.bits=new Uint8Array(Math.max(1,t.length));for(let e=0;e<t.length;e++){let n=t[e];n!==void 0&&(this.bits[e]=n)}}inc(){this.action(new b(0,0))!==void 0&&u()}tdec(){let t=this.action(new b(1,0));return t===void 0&&u(),t}read(){let t=this.action(new b(2,0));return t===void 0&&u(),t}set(){if(this.action(new b(3,0))!==void 0)return u()}extend(){let t=this.pointer,n=this.bits.length;if(t>=n){let s=n*2;for(;t>=s;)s*=2;let i=new Uint8Array(s);i.set(this.bits),this.bits=i}t>=this.length&&(this.length=t+1)}toNumberString(t=10){return(es?BigInt:Number)("0b"+rs(this.bits.slice(0,this.length))).toString(t)}toObject(){this.extend();let t=Array.from(this.bits.slice(0,this.length)),e=this.pointer;return{prefix:t.slice(0,e),head:t[e]??u(),suffix:t.slice(e+1)}}setByRegistersInit(t,e){if(typeof e=="number")this.setBits(pn(e.toString(2)).reverse()),this.extend();else if(!Array.isArray(e)||e.length!==2)J(t,e);else{let[n,s]=e;if(typeof n!="number"||typeof s!="string"||n<0||!Number.isInteger(n))J(t,e);else{let i=pn(s);this.pointer=n,this.setBits(i),this.extend()}}}};var ge=class{constructor(){this.value=0}action(t){switch(t.op){case 0:return this.mul0();case 1:return this.mul1();default:throw Error("MUL: action")}}getValue(){return this.value}mul0(){let t=this.value,e=t%2;return this.value=t>>1,e}mul1(){let t=this.value,e=t%2;return t<=21?this.value=(t>>1)+5:this.value=t-22>>1,e}toString(){return this.value.toString(2).padStart(5,"0")}};var xe=class{constructor(){}action(){return 0}};var ye=class{#t="";constructor(){}action(t){this.output(t.digit)}getString(){return this.#t}output(t){this.#t+=t}};var be=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.b0();case 0:return this.a1();case 2:return this.b1();default:u()}}getValue(){return this.value}a1(){this.value=(this.value+1)%4}b0(){let t=this.value,e=t%2;return this.value=t>=2?3:0,e}b1(){let t=this.value,e=1-t%2;return this.value=t===0||t===3?3:0,e}toString(){return this.value.toString(2).padStart(2,"0")}toStringDetail(){return this.toString()}};var Se=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 0:return this.inc();case 2:return this.read();case 1:return this.dec();case 3:return this.set();case 4:return this.reset();default:u()}}getPointer(){return this.pointer}getBits(){return this.bits}inc(){let t=this.bits;return this.pointer===t.length-1?(t.push(0),this.pointer++,0):(this.pointer++,1)}dec(){return this.pointer===0?0:(this.pointer--,1)}read(){let t=this.pointer,e=this.bits,n=e[t];if(n===0)return e[t]=-1,0;if(n===1)return e[t]=-1,1;if(n===-1)throw Error("Error: reading empty space of T register");u()}set(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=1;else throw Error("Error: SET to nonempty bit")}reset(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=0;else throw Error("Error: RESET to nonempty bit")}};var Gt=(r,t)=>{throw Error(`Register ${r}${t} is not found.`)},dn=Number.parseInt,fn=Number.isNaN,Ee=class{constructor({unary:t,binary:e,legacyT:n}){this.uRegMap=new Map(t.map(s=>[s,new me])),this.bRegMap=new Map(e.map(s=>[s,new he])),this.legacyTRegMap=new Map(n.map(s=>[s,new Se])),this.add=new fe,this.sub=new be,this.mul=new ge,this.b2d=new zt,this.matrixPrinter=new zt,this.output=new ye,this.nop=new xe}setByRegistersInit(t){for(let[e,n]of Object.entries(t))this.#t(e,n)}setCache(t){t instanceof b?t.registerCache=this.getBReg(t.regNumber):t instanceof E&&(t.registerCache=this.getUReg(t.regNumber))}#t(t,e){if(t.startsWith("U")){let n=dn(t.slice(1),10);fn(n)&&J(t,e);let s=this.getUReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: U${n} isn't used in the program`);s.setByRegistersInit(t,e)}else if(t.startsWith("B")){let n=dn(t.slice(1),10);fn(n)&&J(t,e);let s=this.getBReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: B${n} isn't used in the program`);s.setByRegistersInit(t,e)}else J(t,e)}execAction(t){if(t instanceof b)return(t.registerCache??this.bRegMap.get(t.regNumber)??Gt("B",t.regNumber)).action(t);if(t instanceof E)return(t.registerCache??this.uRegMap.get(t.regNumber)??Gt("U",t.regNumber)).action(t);if(t instanceof B)return this.add.action(t);if(t instanceof ot)return this.nop.action();if(t instanceof K)return this.sub.action(t);if(t instanceof j)return this.mul.action(t);if(t instanceof X)if(t.kind===1){if(t.op===2)throw Error("PRINTER component cannot READ");return this.matrixPrinter.action(t)}else return this.b2d.action(t);else{if(t instanceof q)return this.output.action(t);if(t instanceof w)return-1;if(t instanceof Q)return(this.legacyTRegMap.get(t.regNumber)??Gt("T",t.regNumber)).action(t)}throw Error(`execAction: unknown action ${t.pretty()}`)}execActionN(t,e){if(t instanceof E)return(t.registerCache??this.uRegMap.get(t.regNumber)??Gt("U",t.regNumber)).actionN(t,e);if(t instanceof b)return(t.registerCache??this.bRegMap.get(t.regNumber)??Gt("B",t.regNumber)).actionN(t,e);if(t instanceof w)return-1;throw Error(`execActionN: ${t.pretty()}`)}getUReg(t){return this.uRegMap.get(t)}getBReg(t){return this.bRegMap.get(t)}addSubMulToUIString(){return`
        ADD = ${this.add.toStringDetail()},
        SUB = ${this.sub.toStringDetail()},
        MUL = ${this.mul.toString()}
        `}};var ns=[b.parse,E.parse,X.parse,ot.parse,B.parse,j.parse,K.parse,q.parse,w.parse,Q.parse],or=r=>{for(let t of ns){let e=t(r);if(e!==void 0)return e}};var _=r=>r!==void 0?` at line ${r}`:"";function ar(r,t,e,n){if(r=r.trim(),!r.startsWith("{"))return`Invalid line "${e}"${_(t)}. ${n} replacements does not start with "{"`;if(!r.endsWith("}"))return`Invalid line "${e}"${_(t)}. ${n} replacements does not end with "}"`;try{return r.slice(1,-1).slice().split(";").map(s=>{let i=s.trim().split("=").map(o=>o.trim());if(i.length!=2)throw new Error(`Invalid line "${e}"${_(t)}. #DEFINE invalid replacements`);return{needle:i[0]??u(),replacement:i[1]??u()}})}catch(s){return s instanceof Error?s.message:u()}}var Vt="INITIAL",I=class{pretty(){return""}},ct=class r extends I{constructor(t){super(),this.content=t}static get key(){return"#COMPONENTS"}pretty(){return r.key+" "+this.content}},ut=class r extends I{constructor(t){super(),this.content=t}static get key(){return"#REGISTERS"}pretty(){return r.key+" "+this.content}};function mn(r){return"{ "+r.map(t=>t.needle+" = "+t.replacement).join("; ")+" }"}var lt=class r extends I{constructor(t,e){super(),this.name=t,this.defaultReplacements=e}static get key(){return"#DEFINE"}pretty(){return r.key+" "+this.name+(this.defaultReplacements.length===0?"":" "+mn(this.defaultReplacements))}},et=class r extends I{constructor(){super()}static get key(){return"#ENDDEF"}pretty(){return r.key}},tt=class r extends I{constructor(t,e){super(),this.templateName=t,this.replacements=e}static get key(){return"#INSERT"}pretty(){return r.key+" "+this.templateName+(this.replacements.length===0?"":" "+mn(this.replacements))}},pt=class extends I{constructor(t){super(),this.filename=t}static get key(){return"#INCLUDE"}pretty(){return tt.key+" "+this.filename}},cr=class extends I{constructor(t){super(),this.str=t}getString(){return this.str}pretty(){return this.getString()}},ur=class extends I{constructor(){super()}pretty(){return""}},ss=r=>{switch(r){case"Z":return r;case"NZ":return r;case"ZZ":return r;case"*":return r;default:return}},Nt=class extends I{constructor({state:t,input:e,nextState:n,actions:s,line:i}){super(),this.state=t,this.input=e,this.nextState=n,this.actions=s,this.line=i,this._string=`${this.state}; ${this.input};${" ".repeat(2-this.input.length)} ${this.nextState}; ${this.actions.map(o=>o.pretty()).join(", ")}`}pretty(){return this._string}},lr=(r,t)=>{let e=r.trim();if(e==="")return new ur;if(e.startsWith("#")){if(e.startsWith(ct.key))return new ct(e.slice(ct.key.length).trim());if(e.startsWith(ut.key))return new ut(e.slice(ut.key.length).trim());if(e.startsWith(lt.key)){let h=e.slice(lt.key.length).trim();if(h.length===0)return`Invalid line "${r}"${_(t)}. #DEFINE needs a name.`;let S,$=[],R=h.indexOf("{");if(R!==-1){S=h.slice(0,R).trim();let T=ar(h.slice(R),t,r,"#DEFINE");if(typeof T=="string")return T;$=T}else S=h;return new lt(S,$??[])}else{if(e.startsWith(et.key))return new et;if(e.startsWith(tt.key)){let h=e.slice(tt.key.length).trim();if(h.length===0)return`Invalid line "${r}"${_(t)}. #INSERT needs a name.`;let S,$=[],R=h.indexOf("{");if(R!==-1){S=h.slice(0,R).trim();let T=ar(h.slice(R),t,r,"#INSERT");if(typeof T=="string")return T;$=T}else S=h;return new tt(S,$)}else if(e.startsWith(pt.key)){let h=e.slice(pt.key.length).trim();return h===""?`Invalid line "${r}"${_(t)}. #INCLUDE needs filename.`:new pt(h)}}return new cr(r)}let s=(e.split("#")[0]??"").split(/\s*;\s*/u);if(s.length<4)return`Invalid line "${r}"${_(t)}`;if(s.length>4)return s[4]===""?`Extraneous semicolon "${r}"${_(t)}`:`Invalid line "${r}"${_(t)}`;let i=s[0]??u(),o=s[1]??u(),a=s[2]??u(),l=(s[3]??u()).trim().split(/\s*,\s*/u).filter(h=>h!==""),f=[];for(let h of l){let S=or(h);if(S===void 0)return`Unknown action "${h}" in "${r}"${_(t)}`;f.push(S)}let m=ss(o);return m===void 0?`Unknown input "${o}" in "${r}"${_(t)}. Expect "Z", "NZ", "ZZ" or "*"`:new Nt({state:i,input:m,nextState:a,actions:f,line:t})},W=r=>_(r.line),D=r=>`"${r.pretty()}"${W(r)}`;var hn=r=>{let t=r.actions;if(t.some(n=>n instanceof w))return;let e=t.filter(n=>n.doesReturnValue());if(e.length!==1)return e.length===0?`Does not return a value in ${D(r)}`:`Does not contain exactly one action that returns a value in "${r.pretty()}": Actions that produce value are ${e.map(n=>`"${n.pretty()}"`).join(", ")}${W(r)}`};var gn=r=>{if(r.nextState===Vt)return`Return to initial state in ${D(r)}`};var xn=r=>{let t=r.actions;if(t.length<=1)return;let e=t.map(s=>s.pretty());e.sort();let n=e.length-1;for(let s=0;s<n;s++){let i=e[s],o=e[s+1];if(i===o)return`Duplicated actions "${i}" in ${D(r)}`}};var yn=r=>{let t=r.actions;if(t.some(n=>n instanceof w))return;let e=t.length;if(!(e<=1))for(let n=0;n<e;n++){let s=t[n]??u();for(let i=n+1;i<e;i++){let o=t[i]??u();if(s.isSameComponent(o))return`Actions "${s.pretty()}" and "${o.pretty()}" use same component in ${D(r)}`}}};var is=(r,t)=>r.line!==void 0&&t?.line!==void 0?` at line ${r.line} and ${t.line}`:"",bn=r=>{if(r.length===0)return;let t=(s,i)=>`Need Z line followed by NZ line in "${s.pretty()}"${is(s,i)}`,e=r.length-1;for(let s=0;s<e;s++){let i=r[s]??u(),o=r[s+1]??u(),a=i.input,c=o.input;if(a==="Z"&&c!=="NZ"||c==="NZ"&&a!=="Z"||a==="Z"&&c==="NZ"&&i.state!==o.state)return[t(i,o)]}let n=r[e];if(n?.input==="Z")return[t(n)]};var rt=class r{constructor(t,e=new Map){this.templates=e,this.array=t}getArray(){return this.array}getTemplates(){return this.templates}pretty(){return this.array.map(t=>t.pretty()).join(`
`)}static parse(t){let e=t.split(/\r\n|\n|\r/u),n=[],s=[],i=new Map,o=null;for(let[a,c]of e.entries()){if(o!=null){if(c.trimStart().startsWith(et.key)&&lr(c,a+1)instanceof et){o=null;continue}let f=i.get(o);f==null&&u(),f.lines.push(c);continue}let l=lr(c,a+1);if(l instanceof lt){if(o!=null)return`#DEFINE needs #ENDDEF ${l.pretty()}`;if(o=l.name,i.has(o))return`#DEFINE duplicate template name ${l.pretty()}`;i.set(o,{defaultReplacements:l.defaultReplacements,lines:[]})}else{if(l instanceof et)return`#ENDDEF needs #DEFINE ${l.pretty()}`;l instanceof I?s.push(l):typeof l=="string"?n.push(l):u()}}return o!=null&&n.push(`#DEFINE needs #ENDDEF. "${o}"`),n.length>0?n.join(`
`):new r(s,i)}};var Sn=r=>{let t=[];{let e=[xn,hn,yn,gn];for(let n of r)for(let s of e){let i=s(n);typeof i=="string"&&t.push(i)}}{let e=[bn];for(let n of e){let s=n(r);s!==void 0&&(t=t.concat(s))}}if(t.length>0)return t.join(`
`)};function os(r,t,e){let n=r;for(let s of e.concat(t.defaultReplacements))n=n.replaceAll(s.needle,s.replacement);return n}function En(r,t){let e=[],n=new Map(r.getTemplates().entries()),s=r.getArray().slice().reverse();function i(o){let a=o.getArray();for(let c=a.length-1;c>=0;c--)s.push(a[c]??u());for(let[c,l]of o.getTemplates()){if(n.get(c)!=null)throw new Error(`#DEFINE duplicate template name "${c}"`);n.set(c,l)}}for(;s.length>=1;){let o=s.pop();if(o instanceof Nt)e.push(o);else if(o instanceof pt){let a=t.find(c=>c.name===o.filename);if(a==null)throw new Error(`#INCLUDE file not found: "${o.filename}". Add a library file.`);i(a.programLines)}else if(o instanceof tt){let a=n.get(o.templateName);if(a==null)throw new Error(`Undefined template: "${o.templateName}" at line "${o.pretty()}"`);let c=a.lines.map(f=>os(f,a,o.replacements)).join(`
`),l=rt.parse(c);if(typeof l=="string")throw new Error(l);i(l)}}return e}var wn="CLOCK-2^";function $n(r){let t=[],e=r.split(",").map(n=>n.trim());for(let n of e)if(n!=="..."&&!(n==="NOP"||n==="HALT_OUT"))if(n==="OUTPUT"||n==="B2D"||n==="PRINTER"||n==="ADD"||n==="SUB"||n==="MUL")t.push(n);else if(n.startsWith(wn)){let s=Number(n.slice(wn.length))}else{let s=n.startsWith("B")?"B":n.startsWith("U")?"U":null;if(s){let i=as(n.slice(1));for(let o of i.map(a=>`${s}${a}`))t.push(o)}}return t}function as(r){let t=r.split("-");if(t.length===1){let e=t[0];if(e?.length===0)throw new Error("Invalid #COMPONENTS");let n=Number(e);if(Number.isNaN(n))throw new Error("Invalid #COMPONENTS");return[n]}else if(t.length===2){if(t.some(i=>i.length===0))throw new Error("Invalid #COMPONENTS");let[e,n]=t.map(i=>Number(i));if(e==null||n==null||Number.isNaN(e)||Number.isNaN(n))throw new Error("Invalid #COMPONENTS");if(e>=100||n>=100)throw new Error("Invalid #COMPONENTS: range declaration must be less than 100");let s=[];for(let i=e;i<n+1;i++)s.push(i);return s}throw new Error("Invalid #COMPONENTS")}var Yt=class r{constructor(t,e,n){this.commands=t,this.componentsHeader=e,this.registersHeader=n}static parse(t,{noValidate:e,libraryFiles:n}={}){let s=rt.parse(t);if(typeof s=="string")return s;let i=[];for(let a of n??[]){let c=rt.parse(a.content);if(typeof c=="string")return c;i.push({name:a.name,programLines:c})}let o=En(s,i);if(!e){if(o.length===0)return"Program is empty";let a=Sn(o);if(typeof a=="string")return a}return new r(o,s.getArray().flatMap(a=>a instanceof ct?[a]:[]),s.getArray().flatMap(a=>a instanceof ut?[a]:[]))}},cs=r=>[...new Set(r)].sort((t,e)=>t-e),pr=r=>{let t=r.commands.flatMap(l=>l.actions),e=l=>cs(t.flatMap(f=>f instanceof l?[f.regNumber]:[])),n=!1,s=!1,i=!1,o=!1,a=!1,c=!1;for(let l of t)l instanceof B?n=!0:l instanceof K?s=!0:l instanceof j?i=!0:l instanceof X?l.kind===1?a=!0:o=!0:l instanceof q&&(c=!0);return{unary:e(E),binary:e(b),legacyT:e(Q),hasAdd:n,hasSub:s,hasMul:i,hasB2D:o,hasPrinter:a,hasOutput:c}},Nn=(r,t)=>{let e=[],n=new Set(r.flatMap(a=>$n(a.content))),s=a=>`Program uses ${a} component but the #COMPONENTS header does not include it.`;t.hasAdd&&!n.has("ADD")&&e.push(s("ADD")),t.hasSub&&!n.has("SUB")&&e.push(s("SUB")),t.hasMul&&!n.has("MUL")&&e.push(s("MUL")),t.hasB2D&&!n.has("B2D")&&e.push(s("B2D")),t.hasPrinter&&!n.has("PRINTER")&&e.push(s("PRINTER")),t.hasOutput&&!n.has("OUTPUT")&&e.push(s("OUTPUT"));let i=[];for(let a of t.unary)n.has("U"+a)||i.push(a);i.length>0&&e.push(`Program uses ${i.map(a=>"U"+a).join(", ")} component${i.length===1?"":"s"} but the #COMPONENTS header does not include ${i.length===1?"it":"them"}.`);let o=[];for(let a of t.binary)n.has("B"+a)||o.push(a);if(o.length>0&&e.push(`Program uses ${o.map(a=>"B"+a).join(", ")} component${o.length===1?"":"s"} but the #COMPONENTS header does not include ${o.length===1?"it":"them"}.`),e.length!==0)throw new Error(e.join(`
`))};var us=r=>r instanceof b&&r.op===0,ls=r=>r instanceof E&&r.op===1,ps=r=>{if(r.input==="NZ"&&r.state===r.nextState&&r.actions.every(t=>!(t instanceof w))&&r.actions.every(t=>t instanceof E||us(t))){let t=r.actions.find(ls);if(t&&t instanceof E)return{tdecU:t}}},ds=r=>{if(r.input==="NZ"&&r.state===r.nextState&&r.actions.every(t=>!(t instanceof w))&&r.actions.length===1&&r.actions.every(t=>t instanceof b)){let t=r.actions.find(e=>e instanceof b&&e.op===1);if(t&&t instanceof b)return{tdecB:t}}},_t=class{constructor(t,e){this.command=t,this.nextState=e,this.tdecuOptimize=ps(t),this.tdecbOptimize=ds(t)}},fr=class{constructor(t,e){this.z=t,this.nz=e}},dr=(r,t)=>{throw Error(`Duplicated command: "${r.pretty()}" and "${t.pretty()}"${W(t)}`)},_n=r=>{let t=new Map,e=[];for(let n of r)t.has(n.state)||(t.set(n.state,t.size),e.push(new fr(void 0,void 0)));for(let n of r){let s=e[t.get(n.state)??u()]??u(),i=t.get(n.nextState);if(i===void 0)throw Error(`Unknown state: "${n.nextState}" at "${n.pretty()}"${W(n)}`);switch(n.input){case"Z":{s.z===void 0?s.z=new _t(n,i):dr(s.z.command,n);break}case"NZ":{s.nz===void 0?s.nz=new _t(n,i):dr(s.nz.command,n);break}case"ZZ":{if(s.nz!==void 0)throw Error(`Invalid input: ZZ with NZ or *: "${n.pretty()}" and "${s.nz.command.pretty()}"${W(n)}`);s.z===void 0?s.z=new _t(n,i):dr(s.z.command,n);break}case"*":{if(s.nz!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.nz.command.pretty()}"${W(n)}`);if(s.z!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.z.command.pretty()}"${W(n)}`);{let o=new _t(n,i);s.z=o,s.nz=o}break}default:u()}}return{states:[...t.keys()],stateMap:t,lookup:e}};var M=(r="error")=>{throw Error(r)},Wt=class r{constructor(t){this.stepCount=0;let e=pr(t);this.actionExecutor=new Ee(e),this.prevOutput=0;let{states:n,stateMap:s,lookup:i}=_n(t.commands);this.lookup=i;for(let a of i){let c=(a.z?.command.actions??[]).concat(a.nz?.command.actions??[]);for(let l of c)this.actionExecutor.setCache(l)}this.currentStateIndex=s.get(Vt)??M(`${Vt} state is not present`),this.stateStatsArray=[],this.states=n,this.stateMap=s,this.program=t,this.analyzeResult=e;for(let a=0;a<i.length*2;a++)this.stateStatsArray.push(0);let o=t.registersHeader;for(let a of o)this.#t(a);t.componentsHeader.length>0&&Nn(t.componentsHeader,e)}static fromString(t,e){let n=Yt.parse(t,{libraryFiles:e??[]});if(typeof n=="string")throw Error(n);return new r(n)}getStateStats(){let t=this.stateStatsArray,e=t.length,n=[];for(let s=0;s<e;s+=2)n.push({z:t[s]??M(),nz:t[s+1]??M()});return n}#t(t){let e=t.content.replace(/'/ug,'"'),n={};try{n=JSON.parse(e)}catch{M(`Invalid #REGISTERS: is not a valid JSON: "${e}"`)}(n===null||typeof n!="object")&&M(`Invalid #REGISTERS: "${e}" is not an object`),this.actionExecutor.setByRegistersInit(n)}getCurrentState(){let t=this.states[this.currentStateIndex];return t===void 0&&M("State name is not found"),t}getStateMap(){return this.stateMap}getPreviousOutput(){return this.prevOutput===0?"Z":"NZ"}getNextCommand(){let t=this.currentStateIndex,e=this.lookup[t];if(e===void 0&&M(`Internal Error: Next command is not found: Current state index: ${t}`),this.prevOutput===0){let s=e.z;if(s!==void 0)return s}else{let s=e.nz;if(s!==void 0)return s}M("Next command is not found: Current state = "+this.getCurrentState()+", output = "+this.getPreviousOutput())}_internalExecActionN(t,e){try{let s=this.actionExecutor;for(let i of t.actions)s.execActionN(i,e)}catch(s){if(s instanceof Error)this.#r(s);else throw s}let n=this.currentStateIndex*2+this.prevOutput;this.stateStatsArray[n]=(this.stateStatsArray[n]??0)+e,this.stepCount+=e}exec(t,e,n,s){let i=n!==-1,o=e?null:performance.now();for(let a=0;a<t;a++){let c=this.getNextCommand(),l=c.tdecuOptimize;if(l){let m=l.tdecU.registerCache?.getValue();if(m!==void 0&&m!==0){m=Math.min(m,t-a),this._internalExecActionN(c.command,m),a+=m-1;continue}}else if(c.tdecbOptimize){let m=c.tdecbOptimize.tdecB.registerCache?.pointer;if(m!==void 0&&m!==0){m=Math.min(m,t-a),this._internalExecActionN(c.command,m),a+=m-1;continue}}try{if(this.execCommandFor(c)===-1)return"Halted"}catch(f){if(f instanceof Error)this.#r(f);else throw f}if(i&&this.currentStateIndex===n&&(s===-1||s===this.prevOutput))return"Stop";if(e&&(a+1)%5e5===0&&o!==null&&performance.now()-o>=50)return}}#r(t){let e=this.getNextCommand().command;return M(t.message+" in "+D(e))}execCommandFor(t){this.stepCount+=1;{let o=this.currentStateIndex,a=this.prevOutput,c=o*2+a;this.stateStatsArray[c]=(this.stateStatsArray[c]??0)+1}let e=-1,n=this.actionExecutor,s=t.command;for(let o of s.actions){let a=n.execAction(o);if(a===-1)return-1;a!==void 0&&(e===-1?e=a:M(`Return value twice: line = ${D(s)}`))}e===-1&&M(`No return value: line = ${D(s)}`);let i=t.nextState;this.currentStateIndex=i,this.prevOutput=e}execCommand(){return this.execCommandFor(this.getNextCommand())}};function d(r,t=void 0){let e=document.createElement(r);if(typeof t=="string")e.textContent=t;else if(t!=null&&typeof t=="object"&&(t.text&&(e.textContent=t.text),t.classes&&e.classList.add(...t.classes),t.fn&&(t.fn(e),t.fn=void 0),t.children&&e.append(...t.children),t.style))for(let[n,s]of Object.entries(t.style))n in e.style?e.style[n]=s:e.style.setProperty(n,s);return e}var fs="Start",ms="Stop",Tn="btn-primary",In="btn-danger",Bn=r=>`<svg width="16" height="16" viewBox="0 0 16 16">${r}</svg>`,hs=()=>{let r=d("div");return r.innerHTML=Bn('<path stroke="currentColor" stroke-width="1" d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>')+fs,r},gs=hs(),xs=()=>{let r=d("div");return r.innerHTML=Bn('<path stroke="currentColor" stroke-width="1" d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z"/>')+ms,r},ys=xs();function Zt(r){r.disabled=!1,r.replaceChildren(gs),r.classList.add(Tn),r.classList.remove(In)}function Dn(r){r.disabled=!1,r.replaceChildren(ys),r.classList.remove(Tn),r.classList.add(In)}function Rn(r,t,e){if(r.replaceChildren(),t==="RuntimeError"||t==="ParseError"){let n=e.split(`
`);for(let s of n)r.append(d("span","- "+s),d("br"));r.classList.remove("d-none")}else r.classList.add("d-none")}var Xt=40,we=window.innerWidth;we>=1200?Xt=120:we>=992?Xt=100:we>=768?Xt=70:we>=576&&(Xt=50);var vn=(r,t)=>{if(t=t??"",r.value===t)return;r.value=t;let e=t.length,s=Math.min(6,Math.max(1,Math.ceil(e/Xt)));r.rows=s};function*Cn(r,t){if(!Number.isInteger(t))throw RangeError("size is not an integer");let e=[];for(let n of r)e.push(n),t<=e.length&&(yield e,e=[]);e.length!==0&&(yield e)}var bs=r=>{if(window.innerWidth<768)return r===9?r:8;let e=12;return e+1<=r&&r<=e+2?r:e},Ss=r=>d("th",{text:`U${r}`,classes:["text-end"]}),Es=(r,t)=>d("td",{text:t.getValue().toString(),fn:e=>{e.dataset.test=`U${r}`},classes:["text-end"]}),ws=r=>{let t=[],e=[],n=bs(r.size);for(let i of Cn(r,n)){let o=d("tr"),a=d("tr");for(let[c,l]of i){o.append(Ss(c));let f=Es(c,l);t.push(f),a.append(f)}e.push({header:o,data:a})}let s=d("table");for(let i of e)s.append(i.header,i.data);return s.classList.add("table"),s.style.tableLayout="fixed",s.style.marginBottom="0",{table:s,cells:t}},$e=class{#t;#r;constructor(t){this.#t=t,this.#r=[]}initialize(t){let{table:e,cells:n}=ws(t);this.#t.replaceChildren(e),this.#r=n}clear(){this.#r=[],this.#t.innerHTML=""}render(t){let e=0,n=this.#r;for(let s of t.values()){let i=n[e]??u();i.textContent=s.getValue().toString(),e++}}};var $s=()=>{let r=d("span",{classes:["decimal"]}),t=d("span",{classes:["hex"]}),e=d("span",{classes:["max_pointer"]}),n=d("span",{classes:["pointer"]});return{metaData:d("code",{classes:["binary_info","word-break-all"],children:[r,t,e,n]}),$decimal:r,$hex:t,$maxPointer:e,$pointer:n}},Ns=()=>{let r=d("span",{classes:["prefix"]}),t=d("span",{classes:["binary-head"]}),e=d("span",{classes:["suffix"]});return{binaryBits:d("code",{classes:["word-break-all"],children:[r,t,e]}),$prefix:r,$head:t,$suffix:e}},Ne=class{#t;#r;constructor(t){this.#t=t,this.#r=[]}initialize(t){this.clear();let e=[],n=d("table");for(let s of t.keys()){let i=d("td");i.dataset.test=`B${s}`;let{metaData:o,$decimal:a,$hex:c,$maxPointer:l,$pointer:f}=$s();i.append(o,d("br"));let{binaryBits:m,$prefix:h,$head:S,$suffix:$}=Ns();i.append(m);let R=d("tr",{children:[d("th",`B${s}`),i]});n.append(R),e.push({$decimal:a,$hex:c,$maxPointer:l,$pointer:f,$prefix:h,$head:S,$suffix:$})}this.#t.append(n),this.#r=e}clear(){this.#r=[],this.#t.innerHTML=""}render(t,e,n,s,i){let o=0,a=this.#r;for(let c of t.values()){let{$prefix:l,$head:f,$suffix:m,$decimal:h,$hex:S,$maxPointer:$,$pointer:R}=a[o]??u();if(e)l.innerHTML="",f.innerHTML="",m.innerHTML="";else{let T=c.toObject();l.textContent=n?sr(T.suffix):ir(T.prefix),f.textContent=T.head.toString(),m.textContent=n?sr(T.prefix):ir(T.suffix)}s?h.textContent="value = "+c.toNumberString(10)+", ":h.innerHTML="",i?S.textContent="hex = "+c.toNumberString(16)+", ":S.innerHTML="",$.textContent="max_pointer = "+(c.getLength()-1)+", ",R.textContent="pointer = "+c.pointer.toString(),o++}}};var mr=(r,t,e,n)=>{let s=Math.min(window.devicePixelRatio||1,4),i=300*s;(r.canvas.width!==i||r.canvas.height!==i)&&(r.canvas.width=i,r.canvas.height=i,r.canvas.style.width=`${(i/s).toFixed(0)}px`,r.canvas.style.height=`${(i/s).toFixed(0)}px`),r.reset?r.reset():(r.clearRect(0,0,i,i),r.resetTransform(),r.beginPath());let o=t.getMaxX(),a=t.getMaxY(),c=Math.max(o,a)+1,l=i/c;n||(r.scale(1,-1),r.translate(0,-i));let f=t.getArray();r.fillStyle="#212529";for(let m=0;m<=a;m++){let h=f[m]??u(),S=m*l;for(let $=0;$<=o;$++)h[$]===1&&r.rect($*l,S,l,l)}r.fill(),e||(r.strokeStyle="#03A9F4",r.lineWidth=4,r.strokeRect(t.x*l,t.y*l,l,l))};var k=r=>r.toLocaleString();var An="stats_current_state",_s=(r,{z:t,nz:e})=>{let n=d("td",{fn:l=>{l.colSpan=2},children:[d("code",r)]}),s="num",i=d("td",{text:k(t+e),classes:[s]}),o=d("td",{text:k(t),classes:[s]}),a=d("td",{text:k(e),classes:[s]});return{$tr:d("tr",{children:[n,i,o,a]}),$sum:i,$z:o,$nz:a}},_e=class{#t;constructor(t,e){this.root=t,this.#t=e,this.cells=[]}initialize(t,e){this.#t.textContent=k(e.length),this.cells=[],this.root.innerHTML="";for(let[n,s]of t.entries()){let i=e[n]??"",{$tr:o,$sum:a,$z:c,$nz:l}=_s(i,s);this.root.append(o),this.cells.push({$sum:a,$z:c,$nz:l,$tr:o})}}clear(){this.#t.innerHTML="",this.cells=[],this.root.innerHTML=""}render(t,e){let n=t,s=this.cells,i=s.length;for(let o=0;o<i;o++){let a=s[o]??u();e===o?a.$tr.classList.add(An):a.$tr.classList.remove(An);let{z:c,nz:l}=n[o]??u();a.$sum.textContent=k(c+l),a.$z.textContent=k(c),a.$nz.textContent=k(l)}}};function Ln(r,t){if(r.innerHTML="",t===void 0)return;let e=d("option","None");e.value="-1",e.selected=!0,r.append(e);for(let[n,s]of t.getStateMap()){let i=d("option",n);i.value=s.toString(),r.append(i)}}function Mn(r){switch(r.value){case"*":return-1;case"Z":return 0;default:return 1}}var Te=class{#t=0;#r=-1;#e=!1;#i=0;#s=0;constructor(t,{frequency:e,signal:n}){this.#i=e;let s=requestAnimationFrame,i=o=>{if(this.#e&&this.#r!==-1){let a=o-this.#r,c=this.#t,l=c+a/1e3*this.#i,f=Math.floor(l)-Math.floor(c);this.#t=l,t(f)}this.#r=o,this.#s=s(i)};this.#s=s(i),n?.addEventListener("abort",()=>{this.abort()})}abort(){this.#s!==0&&cancelAnimationFrame(this.#s)}get frequency(){return this.#i}set frequency(t){this.#i=t}get disabled(){return!this.#e}set disabled(t){this.#e=!t}reset(){this.#t=0}};var hr=r=>r instanceof Error?r.message:"Unknown error is occurred.";var kn=()=>{let r=d("span");return r.classList.add("spinner-border","spinner-border-sm"),r.setAttribute("role","status"),r.setAttribute("aria-hidden","true"),r};function Ts(r,t){let e=d("input");e.type="file",e.style.display="none",r.addEventListener("click",()=>{e.click()}),e.addEventListener("change",()=>{let n=e.files;if(n!=null&&n.length>0){let s=n[0];s!=null&&t(s)}}),document.body.append(e)}var Ie=class{#t;constructor(){this.#t=[]}getFiles(){return this.#t.slice()}initialize(){ae.addEventListener("click",async()=>{ae.disabled=!0,this.addFile({name:"binary.apglib",content:await fetch("./frontend/data/binary.apglib").then(t=>{if(!t.ok)throw new Error("Failed to load");return t.text()}),builtin:!0}),await new Promise(t=>setTimeout(t,500)),Ae.click()}),Ts(Xr,async t=>{this.addFile({name:t.name,content:await t.text()}),await new Promise(e=>setTimeout(e,500)),Ae.click()})}addFile(t){this.#t.push(t);let e=d("td");e.textContent=t.name;let n=d("button",{text:"Delete"});n.className="btn btn-danger btn-sm",n.addEventListener("click",()=>{t.builtin&&(ae.disabled=!1),this.#t=this.#t.filter(o=>o.name!==t.name),i.remove()});let s=d("td",{children:[n]}),i=d("tr",{children:[e,s]});jr.append(i)}};var Is=30,Be=class{#t;#r="";#e;#i;#s=new $e(Or);#c=new Ne(Pr);#a=new _e(Yr,Wr);$libraryUI=new Ie;#o;#n="Initial";constructor(){this.stepConfig=1,this.#o=new Te(t=>{this.run(t)},{frequency:Is}),this.$libraryUI.initialize()}setFrequency(t){this.#o.frequency=t,this.#u()}start(){switch(this.#n){case"Initial":{this.reset()&&(this.#n="Running");break}case"Stop":{this.#n="Running";break}default:throw Error("start: unreachable")}this.render()}stop(){this.#n="Stop",this.render()}toggle(){this.#n==="Running"?this.stop():this.start()}#l(){this.#e===void 0?this.#s.clear():this.#s.initialize(this.#e.actionExecutor.uRegMap)}#p(){this.#e===void 0?this.#c.clear():this.#c.initialize(this.#e.actionExecutor.bRegMap)}#d(){this.#l(),this.#p(),this.#h(),Ln(ve,this.#e)}doStep(){if(this.#n==="Running"&&this.stop(),this.stepConfig>=5e6){let t=kn();t.style.position="absolute",C.append(t),Jt.style.color="transparent",C.disabled=!0,F.disabled=!0,v.disabled=!0,setTimeout(()=>{try{this.run(this.stepConfig)}finally{Jt.style.color="",t.remove()}},33)}else this.run(this.stepConfig)}setInputAndReset(t){O.value=t,this.reset()}reset(){this.#r="",this.#e=void 0,this.#o.reset();try{let t=this.$libraryUI.getFiles();this.#e=Wt.fromString(O.value,t),this.#d(),this.#n="Stop"}catch(t){return this.#n="ParseError",this.#r=hr(t),this.render(),!1}return this.render(),!0}#u(){let t=this.#o.frequency;this.#i!==t&&(kr.textContent=k(t),this.#i=t)}#f(){try{let t=this.#e?.getNextCommand();Ur.textContent=t?.command.pretty()??""}catch(t){console.error(t)}}renderB2D(){if(!gt.open)return;let t=this.#e;if(t===void 0){Tt.x.textContent="0",Tt.y.textContent="0",ee.clearRect(0,0,te.width,te.height),ee.resetTransform();return}let e=t.actionExecutor.b2d;Tt.x.textContent=e.x.toString(),Tt.y.textContent=e.y.toString();let n=performance.now();mr(ee,e,Ct.checked,yt.checked),this.#n==="Running"&&performance.now()-n>=200&&(gt.open=!1)}renderPrinter(){if(!xt.open)return;let t=this.#e;if(t===void 0){It.x.textContent="0",It.y.textContent="0",se.clearRect(0,0,ne.width,ne.height),se.resetTransform();return}let e=t.actionExecutor.matrixPrinter;It.x.textContent=e.x.toString(),It.y.textContent=e.y.toString();let n=performance.now();mr(se,e,Ct.checked,yt.checked),this.#n==="Running"&&performance.now()-n>=200&&(xt.open=!1)}renderUnary(){this.#e!==void 0&&Bt.open&&this.#s.render(this.#e.actionExecutor.uRegMap)}renderBinary(){this.#e!==void 0&&Dt.open&&this.#c.render(this.#e.actionExecutor.bRegMap,N.$hideBits.checked,N.$reverseBits.checked,N.$showBinaryValueInDecimal.checked,N.$showBinaryValueInHex.checked)}#m(){let t=this.#e?.actionExecutor.output.getString();vn(Rr,t)}#h(){let t=this.#e;t===void 0?this.#a.clear():this.#a.initialize(t.getStateStats(),t.states)}renderStats(){if(!oe.classList.contains("show"))return;let t=this.#e;if(t===void 0){this.#a.clear();return}this.#a.render(t.getStateStats(),t.currentStateIndex)}#g(){switch(this.#n){case"Initial":{Zt(v),C.disabled=!1,F.disabled=!1,ht.disabled=!0;break}case"Stop":{Zt(v),C.disabled=!1,F.disabled=!1,ht.disabled=!1;break}case"Running":{Dn(v),C.disabled=!0,F.disabled=!0,ht.disabled=!1;break}case"RuntimeError":case"ParseError":{Zt(v),v.disabled=!0,C.disabled=!0,F.disabled=!1,ht.disabled=!0;break}case"Halted":{Zt(v),v.disabled=!0,C.disabled=!0,F.disabled=!1,ht.disabled=!1;break}}}render(){let t=this.#e,e=this.#n;if(this.#o.disabled=e!=="Running",this.#t!==e||e==="Stop"){this.#g(),e==="ParseError"?O.classList.add("is-invalid"):O.classList.remove("is-invalid");let s=t?.analyzeResult;Bt.style.display=s==null||s.unary.length===0?"none":"",Dt.style.display=s==null||s.binary.length===0?"none":"",Hr.style.display=s?.hasAdd||s?.hasSub||s?.hasMul?"":"none",gt.style.display=s?.hasB2D?"":"none",xt.style.display=s?.hasPrinter?"":"none",Dr.style.display=s?.hasOutput?"":"none"}Rn(Br,e,this.#r),this.#u(),Ar.textContent=t?.getCurrentState()??"",Lr.textContent=t?.getPreviousOutput()??"",vr.textContent=t?.stepCount.toLocaleString()??"";let n=this.stepConfig;Jt.textContent=n===1?"Step":`${k(n)} Steps`,this.#f(),this.#m(),this.renderUnary(),this.renderBinary(),Fr.textContent=t?.actionExecutor.addSubMulToUIString()??"",this.renderB2D(),this.renderPrinter(),this.renderStats(),this.#t=e}run(t){switch(this.#n){case"Initial":if(!this.reset())return}if(t<=0||isNaN(t))return;let e=this.#e;if(e===void 0)return;let n=this.#n==="Running",s=parseInt(ve.value,10),i=Mn(Vr);try{let o=e.exec(t,n,s,i);o!==void 0&&(this.#n=o)}catch(o){this.#n="RuntimeError",this.#r=hr(o)}finally{this.render()}}};var Bs="./frontend/data/",y=new Be;F.addEventListener("click",()=>{y.reset()});v.addEventListener("click",()=>{y.toggle()});C.addEventListener("click",()=>{y.doStep()});Gr.forEach(r=>{r.addEventListener("click",async()=>{ie.style.opacity="0.5";let t=r.dataset.src;try{let e=await fetch(Bs+t);if(!e.ok)throw Error("error");y.setInputAndReset(await e.text()),wr()}catch(e){throw e}finally{ie.removeAttribute("style")}})});$r(Mr,y);gt.addEventListener("toggle",()=>{y.renderB2D()});xt.addEventListener("toggle",()=>{y.renderPrinter()});Dt.addEventListener("toggle",()=>{y.renderBinary()});Bt.addEventListener("toggle",()=>{y.renderUnary()});var wr=()=>{O.scrollTop=0};Tr(zr,r=>{y.setInputAndReset(r),wr()});Rt.addEventListener("input",()=>{let r=Number(Rt.value);isNaN(r)||r<=0||!Number.isInteger(r)?(Nr(Rt,"Enter a positive integer"),y.stepConfig=1):(_r(Rt),y.stepConfig=r),y.render()});var qt=(r,t)=>{r.addEventListener("change",()=>{y.render(),dt(t,r.checked.toString())})},gr="apge_hide_binary";qt(N.$hideBits,gr);var xr="apge_reverse_binary";qt(N.$reverseBits,xr);var jt="apge_show_binary_in_decimal";qt(N.$showBinaryValueInDecimal,jt);var yr="apge_show_binary_in_hex";qt(N.$showBinaryValueInHex,yr);Ct.addEventListener("change",()=>{y.renderB2D(),y.renderPrinter()});var br="apge_b2d_flip_upside_down";qt(yt,br);oe.addEventListener("shown.bs.modal",()=>{y.renderStats()});Zr.addEventListener("click",()=>{O.value.length>=10**6||(dt("state-diagram-input",O.value),window.open("./tools/diagram/index.html",void 0,"noreferrer=yes,noopener=yes"))});var Sr="apge_dark",De="on",Er="dark_mode";vt.addEventListener("change",()=>{vt.checked?(dt(Er,De),document.body.setAttribute(Sr,De)):(Qt(Er),document.body.removeAttribute(Sr)),Ce.textContent=vt.checked?"On":"Off";let r="dark-mode-anim";document.body.classList.add(r),Re.classList.add(r),setTimeout(()=>{document.body.classList.remove(r),Re.classList.remove(r)},500)});document.addEventListener("keydown",r=>{if(!(Ir()||r.isComposing||r.metaKey||r.shiftKey||r.ctrlKey))switch(r.code){case"Enter":{y.toggle();break}case"Space":{C.disabled||(r.preventDefault(),y.doStep());break}}});O.addEventListener("drop",async r=>{r.preventDefault();let t=r.dataTransfer?.files.item(0);t!=null&&(y.setInputAndReset(await t.text()),wr())});ie.disabled=!1;Cr.disabled=!1;y.render();Kt(()=>{let r="initial_code",t=ft(r);t!==null&&(Qt(r),y.setInputAndReset(t))});Kt(()=>{mt("hide_binary",gr),mt("show_binary_in_decimal",jt),mt("reverse_binary",xr),mt("b2d_flip_upside_down",br),mt("show_binary_in_hex",yr),ft(jt)===null&&dt(jt,"true");let r=[{key:br,checkbox:yt},{key:xr,checkbox:N.$reverseBits},{key:gr,checkbox:N.$hideBits},{key:jt,checkbox:N.$showBinaryValueInDecimal},{key:yr,checkbox:N.$showBinaryValueInHex}];for(let{key:t,checkbox:e}of r)ft(t)==="true"&&(e.checked=!0);ft(Er)===De&&(document.body.setAttribute(Sr,De),vt.checked=!0,Ce.textContent="On"),y.render()});"serviceWorker"in navigator&&Kt(async()=>{(await navigator.serviceWorker.getRegistrations()).map(t=>t.unregister())});
